import{m as f,d as h}from"./vendor/vendor-core.3574f8d9.js";import{u as m,r as g}from"./uploader.da0c2632.js";import{E as n}from"./event-bus.6a5776a8.js";import{e as v,h as C}from"./app.a373aa59.js";import{n as x}from"./_plugin-vue2_normalizer.7b9a2fe2.js";import{b as p}from"./vendor/vendor-essential.91b5cfa2.js";const $={name:"file-uploader",components:{},props:{data:{type:Array,default(){return[]}},additionalFormData:{type:Object,default(){return{}}},requestIdentifier:{type:String,default:p()},url:{type:String,default:"/uploads"},heading:{type:String,default:null},actionLabel:{type:String,default:"global.choose"},nameLabel:{type:String,default:"upload.file"},namesLabel:{type:String,default:"upload.files"},buttonWrapperClasses:{type:String,default:"justify-content-start"},headingClasses:{type:String,default:"mb-2"},buttonClasses:{type:String,default:"mb-2"},buttonIcon:{type:String,default:"fas fa-upload"},buttonDesign:{type:String,default:"primary"},options:{type:Object,required:!0},autoUpload:{type:Boolean,default:!0},multiple:{type:Boolean,default:!0},hideButtonLabel:{type:Boolean,default:!1},hideFileList:{type:Boolean,default:!1},hideResetButton:{type:Boolean,default:!1},hideAfterUpload:{type:Boolean,default:!0},showSelectedFilesCount:{type:Boolean,default:!1}},data(){return{isLoading:!1,fileRemoved:!1,actionLabelUpdated:"",files:[],uploadedFiles:[],existingFiles:[],icons:v,mimeTypes:C}},computed:{...f("config",["configs","vars"]),computedActionLabel(){return this.existingFile?"global.change":this.actionLabel}},watch:{data(a){this.existingFiles=a.map(t=>({...t,status:null}))},"options.uuid":{deep:!0,handler(a,t){a&&a!==t&&this.reset()}}},methods:{getFileIcon(a){return this.icons[a]||"fa-file-alt"},getFileNameIcon(a){return this.icons[a]||"fa-file-alt"},generateFilesList(a){this.isLoading=!0;let t=null;const s=this.$refs.filesInput.files;if(this.options.allowedExtensions&&(_.isArray(this.options.allowedExtensions)||(this.options.allowedExtensions=this.options.allowedExtensions.split(",")),t=new RegExp("(."+this.options.allowedExtensions.join("|.")+")$")),this.options.maxNoOfFiles&&s.length+this.existingFiles.length>this.options.maxNoOfFiles){this.$toasted.error(this.$t("upload.max_file_limit_crossed",{number:this.options.maxNoOfFiles}),this.$toastConfig.error);return}for(let e=0;e<s.length;e++)t&&!t.test(s[e].name)?(this.isLoading=!1,this.$toasted.error(this.$t("global.file_not_supported",{attribute:s[e].name.split(".").pop()}),this.$toastConfig.error)):s[e].size>this.configs.system.postMaxSize?(this.isLoading=!1,this.$toasted.error(this.$t("global.file_too_large",{attribute:s[e].name}),this.$toastConfig.error)):this.files.push({uuid:p(),file:s[e],status:"waiting",progress:0});this.isLoading=!1,this.$emit("selected",this.files.length),this.autoUpload&&this.startUploading()},startUploading(){if(this.files.filter(t=>t.status==="waiting").length){let t=[];const s=h.CancelToken;this.$emit("uploading",this.files.length);for(let e=0;e<this.files.length;e++){const i=this.files[e];if(t[e]=l=>{i.progress=Math.round(l.loaded*100/l.total)},i.status==="waiting"){let l=new FormData;l.append("file",i.file),l.append("mime",i.file.type),l.append("token",this.options.token),l.append("module",this.options.module),l.append("request_uuid",this.requestIdentifier),l.append("first_attachment",e===0),l.append("last_attachment",e===this.files.length-1),this.additionalFormData.objForEach((o,r)=>{o&&(_.isObject(o)?l.append(r.snakeCase(),JSON.stringify(o)):l.append(r.snakeCase(),o))}),i.status="uploading";let d=new s(o=>{i.cancel=o});m({url:this.url,data:l},t[e],d).then(o=>{o.upload?this.uploadedFiles.push(o.upload):o.attachments&&this.uploadedFiles.push(o.attachments),i.uuid=o.upload?o.upload.uuid:o.uuid,i.status="justUploaded",delete i.cancel,setTimeout(()=>{i.status="uploaded",this.hideAfterUpload&&delete this.files.splice(this.files.findIndex(r=>r.uuid===i.uuid),1)},2e3),this.$emit("updated",o),this.checkUploadStatus(o)}).catch(o=>{if(this.$emit("error",{...o,requestUuid:this.requestIdentifier}),o.response&&o.response.data){const r=o.response.data||{},u=r.errors?formUtil.assignErrors(r.errors):{};i.error=u.message,this.$toasted.error(u.message,this.$toastConfig.error),i.status="error",setTimeout(()=>{delete this.files.splice(this.files.findIndex(c=>c.uuid===i.uuid),1)},3e3),this.$emit("updated",{...o,requestUuid:this.requestIdentifier}),this.checkUploadStatus()}else i.status="cancelled",setTimeout(()=>{delete this.files.splice(this.files.findIndex(r=>r.uuid===i.uuid),1)},3e3)})}}}},removeFile(a,t,s=!1){formUtil.confirmAction().then(e=>{e.value&&(this.isLoading=!0,g({url:this.url+"/"+a.uuid,data:{token:this.options.token,module:this.options.module}}).then(i=>{a.status="removed",setTimeout(()=>{s?delete this.existingFiles.splice(this.existingFiles.findIndex(l=>l.uuid===a.uuid),1):delete this.files.splice(this.files.findIndex(l=>l.uuid===a.uuid),1)},3e3),this.isLoading=!1,this.$toasted.success(i.message,this.$toastConfig.success),this.$emit("selected",this.files.length),this.$emit("updated",i),this.checkUploadStatus()}).catch(i=>{const l=i.response.data||{},d=l.errors?formUtil.assignErrors(l.errors):{};this.$toasted.error(d.message,this.$toastConfig.error),a.error=d.message,a.status="removeError"}))})},checkUploadStatus(a){let t=!0;for(let s=0;s<this.files.length;s++)this.files[s].status!=="justUploaded"&&this.files[s].status!=="uploaded"&&(t=!1);t?this.$emit("uploaded",this.uploadedFiles):this.$emit("error",{requestUuid:this.requestIdentifier})},reset(){this.isLoading=!1,this.fileRemoved=!1,this.actionLabelUpdated="",this.files=[],this.uploadedFiles=[];const a=this.$refs.filesInput;a.type="text",a.type="file",this.$emit("selected",this.files.length)},startUpload(){this.files.length?this.startUploading():this.$emit("noNeed")}},mounted(){n.$off("START_UPLOAD",this.startUpload),n.$on("START_UPLOAD",this.startUpload),n.$off("RESET_UPLOAD",this.reset),n.$on("RESET_UPLOAD",this.reset),this.existingFiles=this.data.map(a=>({...a,status:null}))},filters:{decimal(a,t=2){return Number(a).toFixed(t)}},destroyed(){n.$off("START_UPLOAD",this.startUpload),n.$off("RESET_UPLOAD",this.reset)}};var w=function(){var t=this,s=t._self._c;return s("div",{staticClass:"sm-uploader file-uploader"},[s("div",{staticClass:"file-uploader-form"},[s("div",{class:["file-selector d-flex flex-wrap",t.buttonWrapperClasses]},[t.heading?s("h5",{class:["title-desc",t.headingClasses]},[t._v(" "+t._s(t.heading)+" ")]):t._e(),s("label",{class:["btn",`btn-${t.buttonDesign}`,t.buttonClasses]},[s("input",{ref:"filesInput",staticClass:"selector-input",attrs:{name:"filesInput",type:"file",id:"filesInput",multiple:t.multiple},on:{change:t.generateFilesList}}),s("span",{staticClass:"button-icon"},[s("i",{class:t.buttonIcon})]),t._v(" "),t.hideButtonLabel?t._e():s("span",{staticClass:"button-label"},[t._v(t._s(t.$t(t.computedActionLabel,{attribute:t.$t(t.namesLabel)})))]),t._v(" "),t.showSelectedFilesCount&&t.files.length?s("span",{staticClass:"button-label bracketed"},[t._v(t._s(t.files.length))]):t._e()]),t.hideFileList&&!t.hideResetButton&&t.files.length?s("button",{class:["btn",`btn-${t.buttonDesign}`,t.buttonClasses],attrs:{type:"button"},on:{click:t.reset}},[t._m(0)]):t._e()])]),t.existingFiles.length||t.uploadedFiles.length||t.files.length?s("div",{class:["files-list-wrapper",{"d-none":t.hideFileList}]},[s("ul",{staticClass:"files-list"},[t._l(t.existingFiles,function(e,i){return s("li",{key:e.uuid,staticClass:"file-details-row"},[s("div",{staticClass:"file-icon"},[s("span",[s("i",{class:["far",t.getFileIcon(e.mime)]})])]),s("div",{staticClass:"file-details"},[s("h6",[t._v(t._s(e.filename))]),e.error?s("p",{staticClass:"text-danger"},[t._v(" "+t._s(e.error)+" ")]):s("p",[s("span",[s("span",{staticClass:"font-weight-700"},[t._v(t._s(t.$t("upload.type")))]),t._v(": "+t._s(t.mimeTypes[e.mime]||e.mime||"Unknown"))]),s("span",{staticClass:"ml-1"},[s("span",{staticClass:"font-weight-700"},[t._v(t._s(t.$t("upload.size")))]),t._v(": "+t._s(t._f("decimal")(e.size/1024,0))+" KB")])])]),s("div",{class:["status-wrapper",{"actions-wrapper":!e.status||e.status==="removeError"}]},[s("transition",{staticClass:"transition-wrapper",attrs:{appear:"",tag:"div",name:"actions",mode:"out-in"}},[e.status==="removed"?s("div",{staticClass:"status-removed-wrapper"},[s("label",{staticClass:"status-text text-danger"},[t._v("Removed!")]),s("span",{staticClass:"status-icon text-danger"},[s("i",{staticClass:"fas fa-trash"})])]):!e.status||e.status==="removeError"?s("div",{staticClass:"actions-buttons"},[e.status==="removeError"?s("label",{staticClass:"status-text text-danger"},[t._v("Error!")]):t._e(),e.status==="removeError"?s("span",{staticClass:"status-icon text-danger"},[s("i",{staticClass:"fas fa-exclamation-triangle"})]):t._e(),s("a",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover.left",modifiers:{hover:!0,left:!0}}],staticClass:"download-btn",attrs:{href:e.fullUrl,target:"_blank",title:t.$t("global.download",{attribute:t.$t(t.nameLabel)})}},[s("i",{staticClass:"fas fa-download"})]),s("button",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover.left",modifiers:{hover:!0,left:!0}}],staticClass:"remove-btn",attrs:{type:"button",title:t.$t("global.remove",{attribute:t.$t(t.nameLabel)})},on:{click:function(l){return t.removeFile(e,i,!0)}}},[s("i",{staticClass:"fas fa-trash"})])]):t._e()])],1)])}),t._l(t.uploadedFiles,function(e,i){return s("li",{key:e.uuid,staticClass:"file-details-row"},[s("div",{staticClass:"file-icon"},[s("span",[s("i",{class:["far",t.getFileIcon(e.mime)]})])]),s("div",{staticClass:"file-details"},[s("h6",[t._v(t._s(e.filename))]),e.error?s("p",{staticClass:"text-danger"},[t._v(" "+t._s(e.error)+" ")]):s("p",[s("span",[s("span",{staticClass:"font-weight-700"},[t._v(t._s(t.$t("upload.type")))]),t._v(": "+t._s(t.mimeTypes[e.mime]||e.mime||"Unknown"))]),s("span",{staticClass:"ml-1"},[s("span",{staticClass:"font-weight-700"},[t._v(t._s(t.$t("upload.size")))]),t._v(": "+t._s(t._f("decimal")(e.size/1024,0))+" KB")])])]),s("div",{class:["status-wrapper",{"actions-wrapper":!e.status||e.status==="removeError"}]},[s("transition",{staticClass:"transition-wrapper",attrs:{appear:"",tag:"div",name:"actions",mode:"out-in"}},[e.status==="removed"?s("div",{staticClass:"status-removed-wrapper"},[s("label",{staticClass:"status-text text-danger"},[t._v("Removed!")]),s("span",{staticClass:"status-icon text-danger"},[s("i",{staticClass:"fas fa-trash"})])]):!e.status||e.status==="removeError"?s("div",{staticClass:"actions-buttons"},[e.status==="removeError"?s("label",{staticClass:"status-text text-danger"},[t._v("Error!")]):t._e(),e.status==="removeError"?s("span",{staticClass:"status-icon text-danger"},[s("i",{staticClass:"fas fa-exclamation-triangle"})]):t._e(),s("a",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover.left",modifiers:{hover:!0,left:!0}}],staticClass:"download-btn",attrs:{href:e.fullUrl,target:"_blank",title:t.$t("global.download",{attribute:t.$t(t.nameLabel)})}},[s("i",{staticClass:"fas fa-download"})]),s("button",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover.left",modifiers:{hover:!0,left:!0}}],staticClass:"remove-btn",attrs:{type:"button",title:t.$t("global.remove",{attribute:t.$t(t.nameLabel)})},on:{click:function(l){return t.removeFile(e,i,!0)}}},[s("i",{staticClass:"fas fa-trash"})])]):t._e()])],1)])}),t._l(t.files,function(e,i){return s("li",{key:i,staticClass:"file-details-row"},[s("div",{staticClass:"file-icon"},[s("span",[s("i",{class:["far",t.getFileIcon(e.file.type)]})])]),s("div",{staticClass:"file-details"},[s("h6",[t._v(t._s(e.file.name))]),e.error?s("p",{staticClass:"text-danger"},[t._v(" "+t._s(e.error)+" ")]):s("p",[s("span",[s("span",{staticClass:"font-weight-700"},[t._v(t._s(t.$t("upload.type")))]),t._v(": "+t._s(t.mimeTypes[e.file.type]||"Unknown"))]),s("span",{staticClass:"ml-1"},[s("span",{staticClass:"font-weight-700"},[t._v(t._s(t.$t("upload.size")))]),t._v(": "+t._s(t._f("decimal")(e.file.size/1024,0))+" KB")])])]),s("div",{class:["status-wrapper",{"actions-wrapper":e.status==="uploaded"||e.status==="removeError"}]},[s("transition",{staticClass:"transition-wrapper",attrs:{appear:"",tag:"div",name:"actions",mode:"out-in"}},[e.status==="uploading"?s("div",{staticClass:"status-uploading-wrapper"},[s("label",{staticClass:"status-action",on:{click:e.cancel}},[t._v(t._s(t.$t("general.cancel")))]),s("progress-ring",{attrs:{progress:e.progress,"stroke-color":t.vars.loaderColor}})],1):e.status==="justUploaded"?s("div",{staticClass:"status-uploaded-wrapper"},[s("label",{staticClass:"status-text text-success"},[t._v("Uploaded!")]),s("span",{staticClass:"status-icon text-success"},[s("i",{staticClass:"fas fa-check"})])]):e.status==="cancelled"?s("div",{staticClass:"status-cancelled-wrapper"},[s("label",{staticClass:"status-text text-danger"},[t._v("Cancelled!")]),s("span",{staticClass:"status-icon text-danger"},[s("i",{staticClass:"fas fa-times"})])]):e.status==="removed"?s("div",{staticClass:"status-removed-wrapper"},[s("label",{staticClass:"status-text text-danger"},[t._v("Removed!")]),s("span",{staticClass:"status-icon text-danger"},[s("i",{staticClass:"fas fa-trash"})])]):e.status==="error"?s("div",{staticClass:"status-error-wrapper"},[s("label",{staticClass:"status-text text-danger"},[t._v("Error!")]),s("span",{staticClass:"status-icon text-danger"},[s("i",{staticClass:"fas fa-exclamation-triangle"})])]):e.status==="uploaded"||e.status==="removeError"?s("div",{staticClass:"actions-buttons"},[e.status==="removeError"?s("label",{staticClass:"status-text text-danger"},[t._v("Error!")]):t._e(),e.status==="removeError"?s("span",{staticClass:"status-icon text-danger"},[s("i",{staticClass:"fas fa-exclamation-triangle"})]):e.status==="uploaded"?s("label",{staticClass:"status-text text-success"},[t._v("Uploaded!")]):t._e(),s("button",{directives:[{name:"b-tooltip",rawName:"v-b-tooltip.hover.left",modifiers:{hover:!0,left:!0}}],staticClass:"remove-btn",attrs:{type:"button",title:t.$t("global.remove",{attribute:t.$t(t.nameLabel)})},on:{click:function(l){return t.removeFile(e,i)}}},[s("i",{staticClass:"fas fa-trash"})])]):t._e()])],1)])})],2)]):t._e()])},y=[function(){var a=this,t=a._self._c;return t("span",{staticClass:"button-icon"},[t("i",{staticClass:"fas fa-times"})])}],b=x($,w,y,!1,null,null,null,null);const I=b.exports;export{I as F};
