import{n as E}from"../../_plugin-vue2_normalizer.7b9a2fe2.js";function T(e,t){if(typeof e=="object"){if(e.getRangeAt){if(e.rangeCount==0)return;e=e.getRangeAt(0)}if(e.cloneRange){let s=e.cloneRange();s.collapse(!0),e=s.startContainer,e.nodeType==1&&(e=e.childNodes[s.startOffset])}if(!!e){for(var n=e;n&&n.nodeType!=1;)n=n.previousSibling;e=n||e.parentNode,e&&S(e,t)}}}function S(e,t){if(e.scrollIntoViewIfNeeded)e.scrollIntoViewIfNeeded(!1);else{t=t||e.parentElement;const n=e.offsetTop-t.scrollTop;(n<0||n>t.offsetHeight-e.offsetHeight)&&(t.scrollTop=e.offsetTop)}}function p(e){const t=window.getSelection();t&&(t.removeAllRanges(),t.addRange(e))}function C(){const e=window.getSelection();if(e&&e.rangeCount>0)return e.getRangeAt(0)}function y(e,t){return t.map(n=>({at:n,index:e.lastIndexOf(n)})).reduce((n,s)=>n.index>s.index?n:s)}function x(e,t){t=t||window;for(var n={top:e.offsetTop,left:e.offsetLeft},s=e.offsetParent;s!=null&&s!=t;)n.left+=s.offsetLeft,n.top+=s.offsetTop,s=s.offsetParent;return n}function _(e,t){do if(t(e))return e;while(e=e&&e.parentNode)}function b(){const e=C();if(e){const t=e.cloneRange();return t.collapse(!0),t.setStart(t.endContainer,0),t}}const N={name:"VueAt",props:{value:{type:String,default:null},at:{type:String,default:null},ats:{type:Array,default:()=>["@"]},suffix:{type:String,default:" "},loop:{type:Boolean,default:!0},allowSpaces:{type:Boolean,default:!0},tabSelect:{type:Boolean,default:!1},avoidEmail:{type:Boolean,default:!0},showUnique:{type:Boolean,default:!0},hoverSelect:{type:Boolean,default:!0},members:{type:Array,default:()=>[]},nameKey:{type:String,default:""},filterMatch:{type:Function,default:(e,t,n)=>e.toLowerCase().indexOf(t.toLowerCase())>-1},deleteMatch:{type:Function,default:(e,t,n)=>t===e+n},scrollRef:{type:String,default:""}},data(){return{bindsValue:this.value!=null,customsEmbedded:!1,hasComposition:!1,atwho:null}},computed:{atItems(){return this.at?[this.at]:this.ats},currentItem(){return this.atwho?this.atwho.list[this.atwho.cur]:""},style(){if(this.atwho){const{list:e,cur:t,x:n,y:s}=this.atwho,{wrap:o}=this.$refs;if(o){const l=x(o),f=this.scrollRef?document.querySelector(this.scrollRef).scrollLeft:0,r=this.scrollRef?document.querySelector(this.scrollRef).scrollTop:0,d=n+f+window.pageXOffset-l.left+"px",u=s+r+window.pageYOffset-l.top+"px";return{left:d,top:u}}}return null}},watch:{"atwho.cur"(e){e!=null&&this.$nextTick(()=>{this.scrollToCur()})},members(){this.handleInput(!0)},value(e,t){this.bindsValue&&this.handleValueUpdate(e)}},mounted(){this.$scopedSlots.embeddedItem&&(this.customsEmbedded=!0),this.bindsValue&&this.handleValueUpdate(this.value)},methods:{itemName(e){const{nameKey:t}=this;return t?e[t]:e},isCur(e){return e===this.atwho.cur},handleValueUpdate(e){const t=this.$el.querySelector("[contenteditable]");e!==t.innerHTML&&(t.innerHTML=e,this.dispatchInput())},dispatchInput(){let e=this.$el.querySelector("[contenteditable]"),t=new Event("input",{bubbles:!0});e.dispatchEvent(t)},handleItemHover(e){this.hoverSelect&&this.selectByMouse(e)},handleItemClick(e){this.selectByMouse(e),this.insertItem()},handleDelete(e){const t=b();if(t){if(this.customsEmbedded&&t.endOffset>=1){let i=t.endContainer.childNodes[t.endOffset]||t.endContainer.childNodes[t.endOffset-1];if(!i||i.nodeType===Node.TEXT_NODE&&!/^\s?$/.test(i.data))return;i.nodeType===Node.TEXT_NODE?i.previousSibling&&(i=i.previousSibling):i.previousElementSibling&&(i=i.previousElementSibling);let h=[].slice.call(i.childNodes);h=[].reverse.call(h),h.unshift(i);let a;if([].some.call(h,c=>{if(c.getAttribute&&c.getAttribute("data-at-embedded")!=null)return a=c,!0}),a){e.preventDefault(),e.stopPropagation();const c=C();c&&(c.setStartBefore(a),c.deleteContents(),p(c),this.handleInput())}return}const{atItems:n,members:s,suffix:o,deleteMatch:l,itemName:f}=this,r=t.toString(),{at:d,index:u}=y(r,n);if(u>-1){const i=r.slice(u+d.length);if(s.some(a=>{const c=f(a);return l(c,i,o)})){e.preventDefault(),e.stopPropagation();const a=C();a&&(a.setStart(a.endContainer,u),a.deleteContents(),p(a),this.handleInput())}}}},handleKeyDown(e){const{atwho:t}=this;if(t){if(e.keyCode===38||e.keyCode===40){e.metaKey||e.ctrlKey||(e.preventDefault(),e.stopPropagation(),this.selectByKeyboard(e));return}if(e.keyCode===13||this.tabSelect&&e.keyCode===9){e.preventDefault(),e.stopPropagation(),this.insertItem();return}if(e.keyCode===27){this.closePanel();return}}(e.keyCode>=48&&e.keyCode<=90||e.keyCode===8)&&setTimeout(()=>{this.handleInput()},50),e.keyCode===8&&this.handleDelete(e)},handleCompositionStart(){this.hasComposition=!0},handleCompositionEnd(){this.hasComposition=!1,this.handleInput()},handleInput(e){if(this.hasComposition)return;const t=this.$el.querySelector("[contenteditable]");this.$emit("input",t.innerHTML);const n=b();if(n){const{atItems:s,avoidEmail:o,allowSpaces:l,showUnique:f}=this;let r=!0;const d=n.toString(),{at:u,index:i}=y(d,s);i<0&&(r=!1);const h=d[i-1],a=d.slice(i+u.length,d.length);if(o&&/^[a-z0-9]$/i.test(h)&&(r=!1),!l&&/\s/.test(a)&&(r=!1),/^\s/.test(a)&&(r=!1),!r)this.closePanel();else{const{members:c,filterMatch:m,itemName:v}=this;!e&&a&&this.$emit("at",a);const g=c.filter(w=>{const I=v(w);return m(I,a,u)});if(r=!1,g.length&&(r=!0,!f)){let w=g[0];a===v(w)&&(r=!1)}r?this.openPanel(g,n,i,u):this.closePanel()}}},closePanel(){this.atwho&&(this.atwho=null)},openPanel(e,t,n,s){const o=()=>{const l=t.cloneRange();l.setStart(l.endContainer,n+s.length);const f=l.getClientRects()[0];this.atwho={range:t,offset:n,list:e,x:f.left,y:f.top-4,cur:0}};this.atwho?o():setTimeout(o,10)},scrollToCur(){const e=this.$refs.cur[0],t=e.parentElement.parentElement;T(e,t)},selectByMouse(e){const n=+_(e.target,s=>s.getAttribute("data-index")).getAttribute("data-index");this.atwho={...this.atwho,cur:n}},selectByKeyboard(e){const t=e.keyCode===38?-1:1,{cur:n,list:s}=this.atwho,o=this.loop?(n+t+s.length)%s.length:Math.max(0,Math.min(n+t,s.length-1));this.atwho={...this.atwho,cur:o}},insertText(e,t){t.deleteContents();const n=t.endContainer;if(n.nodeType===Node.TEXT_NODE){const s=t.endOffset;n.data=n.data.slice(0,s)+e+n.data.slice(s),t.setEnd(n,s+e.length)}else{const s=document.createTextNode(e);t.insertNode(s),t.setEndAfter(s)}t.collapse(!1),p(t),this.dispatchInput()},insertHtml(e,t){t.deleteContents();const n=t.endContainer;var s=document.createElement("span");if(s.appendChild(document.createTextNode(" ")),s.appendChild(this.htmlToElement(e)),s.appendChild(document.createTextNode(" ")),s.setAttribute("data-at-embedded",""),s.setAttribute("contenteditable",!1),n.nodeType===Node.TEXT_NODE){const l=t.endOffset;var o=n.splitText(l);n.parentNode.insertBefore(s,o),t.setEndBefore(o)}else{const l=document.createTextNode(this.suffix);t.insertNode(s),t.setEndAfter(s),t.insertNode(l),t.setEndAfter(l)}t.collapse(!1),p(t)},insertItem(){const{range:e,offset:t,list:n,cur:s}=this.atwho,{suffix:o,atItems:l,itemName:f,customsEmbedded:r}=this,d=e.cloneRange(),u=e.toString(),{at:i,index:h}=y(u,l),a=r?h:h+i.length;d.setStart(d.endContainer,a),p(d),p(d);const c=n[s];if(r){const m=this.$refs.embeddedItem.firstChild.innerHTML;this.insertHtml(m,d)}else{const m=f(c)+o;this.insertText(m,d)}this.$emit("insert",c),this.handleInput(),T(d)},htmlToElement(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}}};var A=function(){var t=this,n=t._self._c;return n("div",{ref:"wrap",staticClass:"atwho-wrap",on:{compositionstart:t.handleCompositionStart,compositionend:t.handleCompositionEnd,input:function(s){return t.handleInput()},"!keydown":function(s){return t.handleKeyDown.apply(null,arguments)}}},[t.atwho?n("div",{staticClass:"atwho-panel",style:t.style},[n("div",{staticClass:"atwho-inner"},[n("div",{staticClass:"atwho-view"},[n("ul",{staticClass:"atwho-ul"},t._l(t.atwho.list,function(s,o){return n("li",{key:o,ref:t.isCur(o)&&"cur",refInFor:!0,staticClass:"atwho-li",class:t.isCur(o)&&"atwho-cur",attrs:{"data-index":o},on:{mouseenter:t.handleItemHover,click:t.handleItemClick}},[t._t("item",function(){return[n("span",{domProps:{textContent:t._s(t.itemName(s))}})]},{item:s})],2)}),0)])])]):t._e(),n("span",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],ref:"embeddedItem"},[t._t("embeddedItem",null,{current:t.currentItem})],2),t._t("default")],2)},R=[],k=E(N,A,R,!1,null,null,null,null);const O=k.exports;export{O as default};
