import{s as l,f as d,c as u,a as m}from"./header.43f859fb.js";import{F as p}from"./FileUploader.78ddb8c0.js";import{z as c,a as D,g as r,w as g}from"./app.a373aa59.js";import{h as F}from"./vendor/vendor-essential.91b5cfa2.js";import{m as n,i as h}from"./vendor/vendor-core.3574f8d9.js";import{E as s}from"./event-bus.6a5776a8.js";import{d as E,c as f}from"./momentz.ae4aeebe.js";const A={DAY_OF_MONTH:{code:"%DAY_OF_MONTH%",example:"Ex. 1-31",outputFormat:"moment",output:"DD"},DAY_OF_YEAR:{code:"%DAY_OF_YEAR%",example:"Ex. 1-365",outputFormat:"moment",output:"DDDD"},YEAR:{code:"%YEAR%",example:"Ex. 2020",outputFormat:"moment",output:"YYYY"},YEAR_SHORT:{code:"%YEAR_SHORT%",example:"Ex. 20",outputFormat:"moment",output:"YY"},MONTH:{code:"%MONTH%",example:"Ex. JANUARY",outputFormat:"moment",output:"MMMM"},MONTH_SHORT:{code:"%MONTH_SHORT%",example:"Ex. JAN",outputFormat:"moment",output:"MMM"},MONTH_NUMBER:{code:"%MONTH_NUMBER%",example:"Ex. 1 - 12",outputFormat:"moment",output:"MM"},DAY:{code:"%DAY%",example:"Ex. MONDAY",outputFormat:"moment",output:"dddd"},DAY_SHORT:{code:"%DAY_SHORT%",example:"Ex. MON",outputFormat:"moment",output:"ddd"},DAY_NUMBER:{code:"%DAY_NUMBER%",example:"Ex. 1 - 7",outputFormat:"moment",output:"E"},DATE:{code:"%DATE%",example:"Ex. 31-08-1987",outputFormat:"moment",output:"YYYY"},TIME:{code:"%DATE%",example:"Ex. 23:59",outputFormat:"moment",output:"mm"}},b=/%(.*?)%/g;function T(t){return t.match(b),A.objForEach((i,e)=>{const a=new RegExp(i.code,"g");if(i.outputFormat==="moment"){const o=F().format(i.output);t=t.replace(a,o)}}),t}const N={components:{FileUploader:p},props:{editData:{type:Object},isFetching:{type:Boolean,default:!1},duplicate:{type:Boolean,default:!1}},data(){return{uuid:null,subUuid:null,formData:{},formErrors:{},formLabels:{},customFilters:{},initianLength:0,initialFormData:null,emptyFormData:null,preRequisite:{},keepAdding:!1,keepAddingOption:"clear_all",keepAddingSelectedFields:null,keepAddingFields:[],areArrayOfObjectsFields:[],isLoading:!0,getInitialDataCalled:!1,doInitBeforeGetInitialData:!1,initUrl:"",initSubUrl:null,dateTimeFields:null,dataType:null,uploaderConfig:{module:"",token:"",allowedExtensions:"",allowedMaxFileSize:null,maxNoOfFiles:5,uuid:uuid()},headerButtons:null}},computed:{...n("config",["configs","vars","allowExtraInput"]),...n("user",["hasPermission","hasRole"]),editing(){return this.editData&&!this.duplicate},showKeepAdding(){return!this.editData||this.duplicate},codePrefix(){return this.formData.codePrefix},lastCodeObj(){return this.preRequisite.codes.find(t=>t.codePrefix===this.formData.codePrefix)},formHasErrors(){let t="";return this.formErrors.objForEach(i=>{_.isObject(i)?i.objForEach(e=>{if(e!==""){let a=e;if(_.isArray(e)){e=e[0];try{a=JSON.parse(e),a=a.title}catch{a=e}}t=t?t+"<br>"+a:a}}):i!==""&&(t=t?t+"<br>"+i:i)}),t}},watch:{editData(t){if(t){let i=t;this.dateTimeFields&&Array.isArray(this.dateTimeFields)&&this.dateTimeFields.forEach(e=>{i[e]&&(i[e]=E(i[e],this.vars.serverDateTimeFormat))}),this.timeFields&&Array.isArray(this.timeFields)&&this.timeFields.forEach(e=>{Array.isArray(e)?i[e[0]]&&(i[e[0]]=f([i[e[0]],i[e[1]]],this.vars.serverTimeFormat,null)):i[e]&&(i[e]=f(i[e],this.vars.serverTimeFormat,null))}),this.mergeFormDataAndEntity?this.formData=_.merge(this.formData,_.cloneDeep(i)):this.formData=Object.assign({},this.formData,_.cloneDeep(i)),this.uuid=this.formData.uuid,this.uploaderConfig&&(this.uploaderConfig.token=this.formData.token),typeof this.addNewRow=="function"&&typeof this.addNewRowIfNone=="function"&&this.addNewRowIfNone(),typeof this.afterEditData=="function"&&this.afterEditData(),this.duplicate&&this.computeCodeNumber(this.formData.codePrefix),window.setTimeout(()=>{this.initialFormData=_.cloneDeep(this.formData)},500)}},codePrefix:function(){this.computeCodeNumber()}},methods:{...h("common",["Init","InitSub","Get","Store","Update","GetPreRequisite","Destroy","Custom","SetPageHeader"]),...h("config",["SetUiConfig","SetConfig"]),computeCodeNumber(){if(this.preRequisite.codes&&this.showKeepAdding){this.lastCodeObj;const t=this.configs[this.dataType].codeDigit;this.lastCodeObj?this.formData.codeNumber=this.numberPadding(this.lastCodeObj.codeNumber+1,t):this.formData.codeNumber=this.numberPadding(1,t)}},numberPadding(t=1,i){return c(t,i||this.configs[this.dataType].codeDigit)},doNothing(){},submit(){if(formUtil.isUnchanged(this.initialFormData,this.formData))return this.$toasted.info(this.$t("general.nothing_changed"),this.$toastConfig.info),!1;if(this.doInit(),this.doInitSub(),this.isLoading=!0,this.beforeSubmit&&typeof this.beforeSubmit=="function"&&this.beforeSubmit()===!1){this.isLoading=!1;return}this.duplicate&&(this.formData.duplicate=!0,this.formData.duplicateFrom=this.uuid,this.formData.uuid=null),(this.formData.uuid?this.Update:this.Store)(this.formData).then(i=>{this.$toasted.success(i.message,this.$toastConfig),typeof this.afterSubmit=="function"?this.afterSubmit(i):this.keepAdding?(this.uploaderConfig.uuid=uuid(),this.formData=formUtil.clearFormConditionally(this.formData,this.initialFormData,this.keepAddingOption,this.keepAddingSelectedFields),this.getInitialDataCalled&&this.getInitialData(),this.resetFormErrors()):(this.initialFormData=_.cloneDeep(this.formData),this.$router.back()),this.isLoading=!1}).catch(i=>{this.isLoading=!1,this.formErrors=Object.assign({},this.formErrors,formUtil.handleErrors(i))})},reset(){formUtil.confirmAction().then(t=>{t.value&&(this.resetFormErrors(),this.formData=Object.assign({},this.formData,_.cloneDeep(this.initialFormData)))})},unsavedCheck(t){formUtil.unsavedCheckAlert(this.initialFormData,this.formData,t)},fillPreRequisite(t){this.preRequisite.objForEach((i,e)=>{this.preRequisite[e]=t.hasOwnProperty(e)?t[e]:i})},setUploaderConfig(t){this.uploaderConfig.objForEach((i,e)=>{this.uploaderConfig[e]=t.hasOwnProperty(e)?t[e]:i})},async getInitialData(t){this.isLoading=!0,this.getInitialDataCalled=!0;try{this.doInitBeforeGetInitialData&&this.doInit();const i=await this.GetPreRequisite(this.customFilters);return this.doInitBeforeGetInitialData&&this.doInitSub(),this.fillPreRequisite(i),i.uploadConfig&&this.setUploaderConfig(i.uploadConfig),typeof this.addNewRow=="function"&&typeof this.addNewRowIfNone=="function"&&this.$nextTick(()=>{this.addNewRowIfNone()}),this.configs[this.dataType]&&this.$nextTick(()=>{this.formData.codePrefix=T(this.configs[this.dataType].codePrefix)}),this.afterGetInitialData&&typeof this.afterGetInitialData=="function"&&this.afterGetInitialData(i),t&&this.$nextTick(()=>{t(i),window.setTimeout(()=>{this.initialFormData=_.cloneDeep(this.formData)},500)}),this.isLoading=!1,i}catch(i){throw this.isLoading=!1,formUtil.handleErrors(i),i}},getEntityData(){this.isLoading=!0,this.Get(this.formData.uuid).then(t=>{this.formData.objForEach((i,e)=>{this.formData[e]=t.hasOwnProperty(e)?t[e]:null}),this.initialFormData=_.cloneDeep(this.formData),this.isLoading=!1}).catch(t=>{this.isLoading=!1,formUtil.handleErrors(t)})},addTag(t){const i={name:t,slug:formUtil.generateSlug(t)};this.preRequisite.tags.push(i),this.formData.tags.push(i)},newModalClose(t){if(this.doInit(),this.doInitSub(),t){const i=()=>{const e=a=>{t.push?this.formData[t.dataTypeArr].push(a):this.formData[t.dataType]=a};this.isLoading=!0,t.dataType&&(t.dontMatch?e(t):t.dataTypeArr&&t.propertyToMatch&&e(this.preRequisite[t.dataTypeArr].find(a=>a[t.propertyToMatch]===t[t.propertyToMatch])||null)),this.isLoading=!1,this.newModalCloseCallback&&_.isFunction(this.newModalCloseCallback)&&this.newModalCloseCallback()};this.getInitialDataCalled?this.getInitialData(i):i()}},getHeaderOptions(){let t=[];this.headerButtons&&(t=t.concat(this.headerButtons));let i=[];return i.push(l()),this.checkSavedDraft()&&(i.push(d()),i.push(u())),{hideLinks:this.hideHeaderLinks||!1,buttons:t,links:i,title:this.pageTitle||"",subTitle:this.pageTitle&&this.subTitle||""}},getKeyBindingOptions(){return{...m}},applyPageHeader(){let t=Object.assign({},this.getHeaderOptions(),this.header||{}),i=Object.assign({},this.getKeyBindingOptions(),this.keyBindings||{});this.SetPageHeader(t),this.SetConfig({keyBindings:i})},async export(t){this.isLoading=!0;try{let i=`Printing ${this.dataTitle||""}`;this.printTitle&&(i=this.printTitle);const e=this.configs.system.printPreview;this.$printComponent("printable",{title:i,autoPrint:!e,autoCloseAfterPrint:!e})}catch{}this.isLoading=!1},resetFormErrors(){this.formErrors={},this.formData&&this.formData.objForEach((t,i)=>{_.isObject(t)&&(!_.isArray(t)||this.areArrayOfObjectsFields.indexOf(i)!=-1)&&(this.formErrors[i]={})})},saveDraft(){const t=this.initUrl.replace("/","_");D(`${this.vars.localStorageKey}_${t}`,this.formData),this.applyPageHeader(),this.$toasted.info(this.$t("general.draft_saved"),this.$toastConfig.info)},checkSavedDraft(){const t=this.initUrl.replace("/","_");return!!r(`${this.vars.localStorageKey}_${t}`,!0)},fetchSavedDraft(){const t=this.initUrl.replace("/","_"),i=r(`${this.vars.localStorageKey}_${t}`,!0);i?(this.formData=Object.assign({},this.formData,_.cloneDeep(i)),this.$toasted.info(this.$t("general.draft_fetched"),this.$toastConfig.info)):this.$toasted.error(this.$t("general.draft_fetched"),this.$toastConfig.error)},clearSavedDraft(){const t=this.initUrl.replace("/","_");g(`${this.vars.localStorageKey}_${t}`),this.applyPageHeader(),this.$toasted.info(this.$t("general.draft_cleared"),this.$toastConfig.info)},doInitSub(){this.initSubUrl&&this.InitSub({url:(this.subUuid?this.subUuid+"/":"")+this.initSubUrl})},doInit(){this.Init({url:this.initUrl}),this.applyPageHeader()}},mounted(){s.$off("ROUTE_LEAVING",this.unsavedCheck),s.$on("ROUTE_LEAVING",this.unsavedCheck),s.$off("SAVE_DRAFT",this.saveDraft),s.$on("SAVE_DRAFT",this.saveDraft),s.$off("FETCH_SAVED_DRAFT",this.fetchSavedDraft),s.$on("FETCH_SAVED_DRAFT",this.fetchSavedDraft),s.$off("CLEAR_SAVED_DRAFT",this.clearSavedDraft),s.$on("CLEAR_SAVED_DRAFT",this.clearSavedDraft),this.$route.params.subUuid&&(this.subUuid=this.$route.params.subUuid),this.doInit(),this.doInitSub(),this.uploaderConfig.token=this.formData.token,this.configs.system&&this.configs.system.allowedFileExtensions&&(this.uploaderConfig.allowedExtensions=this.configs.system.allowedFileExtensions),this.configs.system&&this.configs.system.postMaxSize&&(this.uploaderConfig.allowedMaxFileSize=this.configs.system.postMaxSize),this.initialFormData=_.cloneDeep(this.formData)},created(){this.emptyFormData=_.cloneDeep(this.formData),this.formLabels&&this.formLabels.objForEach((t,i)=>{this.keepAddingFields.push({uuid:i,value:t})}),this.resetFormErrors()},beforeDestroy(){delete this.formData,delete this.formErrors,delete this.formLabels,delete this.preRequisite,delete this.keepAddingFields},destroyed(){s.$off("ROUTE_LEAVING",this.unsavedCheck),s.$off("SAVE_DRAFT",this.saveDraft),s.$off("FETCH_SAVED_DRAFT",this.fetchSavedDraft),s.$off("CLEAR_SAVED_DRAFT",this.clearSavedDraft)}};export{N as f};
