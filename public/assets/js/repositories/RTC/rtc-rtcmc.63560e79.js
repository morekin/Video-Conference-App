import{l as we}from"../../index.d951cdc8.js";import{R as Ie}from"../../hark.bundle.8af12079.js";import"../../vendor/vendor-webrtc-adapter.d803ee7d.js";import"../../vendor/vendor-others.c8ba1624.js";import{L as Pe}from"../../logger.45fb8d96.js";import"../../vendor/vendor-laravel-echo.aae8cf55.js";import"../../vendor/vendor-core.3574f8d9.js";import"../../vendor/vendor-pusher-js.7eab09ad.js";import"../../app.a373aa59.js";import"../../vendor/vendor-essential.91b5cfa2.js";import"../../vendor/vendor-bootstrap-vue.17129278.js";import"../../vendor/vendor-vue-gtag.f8884558.js";let D=document.createElement("script");D.setAttribute("src","/js/EBML.js");document.head.appendChild(D);window.io=we;function Je(){const U=window.atob("aHR0cHM6Ly9zaWduYWx2Mi5rb2RlbWludC5pbjo5MDAyLw==");let n=null,f=!1,R={},T={debug:!1,iceServers:[],mediaServers:[],signalServer:U,opaqueId:"KMConnect",maxParticipants:1e3},g={},m={},v={},x={},O={},M={},h=[];const r=new Pe;let C=null;r.log("RTC Library RTCMC Loaded!");async function N(e={}){if(!e.config)throw"RTC Library config not defined!";if(T=Object.assign(T,e.config),e.callbacks&&(g=Object.assign(g,e.callbacks)),r.setDebug(T.debug),r.log("RTCMC - init called",e),!n&&e.options){const t={...e.options};F(t)}return{getInstance:B,getUserInfo:W,getInstanceUserId:J,initSession:F,setupFileSharing:q,startMeeting:G,joinMeeting:z,leaveMeeting:K,publishFeed:I,updatePublishedFeed:X,sendMessage:p,acceptJoiningRequest:Y,roomExists:j,close:L,shareFile:Z,getAllStreams:$,updateSessionOptions:Q}}function B(){return n}function W(){var e;return(e=n.extra)==null?void 0:e.user}function J(){return n.userid}function F(e={}){const t=S(e);r.log("RTCMC - initSession called",t),E(t)}function q(e={}){e.callbacks&&(g=Object.assign(g,e.callbacks)),n.enableFileSharing=!0,n.chunkSize=15*1e3,n.onFileStart=ye,n.onFileProgress=Ee,n.onFileEnd=je}function G(e={}){const t=S(e);r.log("RTCMC - startMeeting called",t);const i=()=>{n.enableScalableBroadcast?(n.userid=t.room,n.connectSocket(s=>{r.log("RTCMC - startMeeting socket join-broadcast"),s.emit("join-broadcast",{broadcastId:t.room,userid:n.userid,typeOfStreams:n.session})})):(r.log("RTCMC - startMeeting createRoom"),A(t))};n?i():(t.success=()=>{i()},E(t))}function z(e={}){const t=S(e);r.log("RTCMC - joinMeeting called",t);const i=()=>{n.enableScalableBroadcast?n.connectSocket(s=>{s.emit("join-broadcast",{broadcastId:t.room,userid:n.userid,typeOfStreams:n.session})}):w(t)};n?i():(t.success=()=>{i()},E(t))}function K(e={}){r.log("RTCMC - leaveMeeting called",e),n.userid,L({...e,callback:()=>{a("leftMeeting")}})}function p({event:e,type:t,data:i={},timeout:s=0,callback:o}){if(!!n){if(e&&n.socket){try{window.setTimeout(()=>{n.socket.emit("Connect-Whisper-"+m.uuid,{event:e,data:{userId:n.userid,extra:n.extra,...i}}),o&&_.isFunction(o)&&o()},s)}catch{}return}try{window.setTimeout(()=>{n.send({type:t,data:i}),o&&_.isFunction(o)&&o()},s)}catch{}}}function Y({participantId:e,userId:t,userPreferences:i}){n.acceptParticipationRequest(e,i),O[t]=!0,u(),r.log("RTCMC - On rtcmOnNewParticipant - manually accepted!"),a("participantJoined",{participantId:e,userId:t,userPreferences:i})}function Q(e={}){var i,s;r.log("RTCMC - updateSessionOptions called",e);const t=S(e);Object.assign(n.extra,{user:{username:t.userObject.username,uuid:t.userObject.uuid,name:t.userObject.name,avatar:(i=t.userObject.profile)==null?void 0:i.avatar,cover:(s=t.userObject.profile)==null?void 0:s.cover},isHost:t.meeting.isHost,canModerate:t.meeting.canModerate,canToggleAudio:t.meetingConfigs.canToggleAudio,canToggleVideo:t.meetingConfigs.canToggleVideo,canHaveStream:t.meetingRules.sendAudio||t.meetingRules.sendVideo}),k()}function a(e,t){r.debug("Got a eventCallback",e),r.debug("Got a eventCallback - data",t),e&&g.hasOwnProperty(e)&&_.isFunction(g[e])&&g[e](t)}function S(e={}){const t={...e};return _.isObject(t.user)&&(t.userObject={...t.user},t.user=JSON.stringify(t.user)),t.user,t.config=Object.assign({},T,t.config),m=t.meeting?t.meeting:m,v=t.meetingConfigs?t.meetingConfigs:v,x=t.meetingRules?t.meetingRules:x,t}async function y(e){return await n.getSocket(t=>{if(t)return t;throw"RTCMC - Socket not found!"})}function E(e={}){var t,i;r.log("RTCMC - createSession called",e),!n&&(n=new Ie,window.rtcmc=n,n.socketURL=e.config.signalServer||U,r.log("RTCMC - socketURL",n.socketURL),n.iceServers=e.config.iceServers,n.autoCreateMediaElement=!1,n.enableLogs=e.config.debug,e.config.forceTurn&&(n.candidates={turn:!0,stun:!1,host:!1}),n.onopen=ge,n.onmessage=Ce,n.onNewParticipant=pe,n.onNumberOfBroadcastViewersUpdated=be,n.onstream=Re,n.onstreamended=Te,n.onMediaError=Oe,n.onerror=Me,n.onUserIdAlreadyTaken=he,n.onExtraDataUpdated=Se,n.onUserStatusChanged=ke,n.onSocketDisconnect=ve,n.socketMessageEvent="Connect-Message-"+m.uuid,n.setCustomSocketEvent("Connect-Whisper-"+m.uuid),O={},M={},n.maxParticipantsAllowed=e.config.maxParticipants,n.mediaConstraints={video:!1,audio:!1,screen:!1},n.dontCaptureUserMedia=!0,e.meetingRules?(n.session=e.meetingRules.session,n.sdpConstraints.mandatory={OfferToReceiveAudio:e.meetingRules.receiveAudio,OfferToReceiveVideo:e.meetingRules.receiveVideo},e.meetingRules.session.oneway&&(n.enableScalableBroadcast=!0,n.autoCloseEntireSession=!0,n.maxRelayLimitPerUser=1,n.socketMessageEvent="scalable-media-broadcast-demo",n.connectSocket(s=>{s.on("join-broadcaster",o=>{r.log("RTCMC - socket join-broadcaster",o),n.session=o.typeOfStreams,n.sdpConstraints.mandatory={OfferToReceiveVideo:!!n.session.video,OfferToReceiveAudio:!!n.session.audio},n.broadcastId=o.broadcastId,w({room:o.userid,force:!0})}),s.on("rejoin-broadcast",o=>{r.log("RTCMC - socket rejoin-broadcast",o),n.attachStreams=[],s.emit("check-broadcast-presence",o,c=>{r.log("RTCMC - socket check-broadcast-presence",o,c),c?(r.log("RTCMC - socket rejoin-broadcast - emitting join-broadcast to join broadcasting"),s.emit("join-broadcast",{broadcastId:o,userid:n.userid,typeOfStreams:n.session})):e.meeting.canModerate?(n.userid=o,r.log("RTCMC - socket rejoin-broadcast - emitting join-broadcast to start broadcasting"),s.emit("join-broadcast",{broadcastId:o,userid:n.userid,typeOfStreams:n.session})):a("roomNotFound")})}),s.on("broadcast-stopped",o=>{r.log("RTCMC - socket broadcast-stopped",o),a("broadcastStopped",o)}),s.on("start-broadcasting",o=>{r.log("RTCMC - socket start-broadcasting",o),m.canModerate?(n.sdpConstraints.mandatory={OfferToReceiveVideo:!1,OfferToReceiveAudio:!1},n.session=o,r.log("RTCMC - socket start-broadcasting room",n.userid),A({room:n.userid,force:!0})):a("roomNotFound")})}))):e.meetingRules={},e.userObject||(e.userObject={...e.user},e.user=JSON.stringify(e.user)),n.extra={user:{username:e.userObject.username,uuid:e.userObject.uuid,name:e.userObject.name,avatar:(t=e.userObject.profile)==null?void 0:t.avatar,cover:(i=e.userObject.profile)==null?void 0:i.cover},isInitiator:!1,isHost:e.meeting.isHost,canModerate:e.meeting.canModerate,canToggleAudio:e.meetingConfigs.canToggleAudio,canToggleVideo:e.meetingConfigs.canToggleVideo,canHaveStream:e.meetingRules.sendAudio||e.meetingRules.sendVideo,broadcastId:e.room,streamsInfo:{}},a("sessionCreated"),u(),_.isFunction(e.success)&&(r.log("RTCMC - Success callback after creating session"),e.success()))}function j(e={}){if(!n){_.isFunction(e.no)&&e.no();return}r.log("RTCMC - roomExists called",e),n.enableScalableBroadcast?y().then(t=>{t.emit("check-broadcast-presence",e.room,i=>{i===!0?(r.log("RTCMC - broadcast room Exists yes"),_.isFunction(e.yes)&&e.yes(t)):(r.log("RTCMC - broadcast room Exists no"),_.isFunction(e.no)&&e.no(t))})}).catch(t=>{r.error(t),_.isFunction(e.no)&&e.no(t)}):n.checkPresence(e.room,(t,i)=>{t===!0?(r.log("RTCMC - room Exists yes"),_.isFunction(e.yes)&&e.yes()):(r.log("RTCMC - room Exists no"),_.isFunction(e.no)&&e.no())})}function A(e={}){r.log("RTCMC - createRoom called",e);const t=()=>{f||(n.extra.isInitiator=!0,n.open(e.room,(i,s,o)=>{f=!1,o?a("createRoomError",o):i===!0&&(f=!0,a("roomCreated",s),H())}))};if(e.force){t();return}j({room:e.room,no(i){t()},yes(){w({...e,force:!0})}})}function w(e={}){r.log("RTCMC - joinRoom called",e);const t=()=>{f||n.join(e.room,(i,s,o)=>{f=!1,i===!1||o?a(o==="Room full"?"roomFullError":"joinRoomError",o):(f=!0,u(),H(),a("roomJoined",s))})};if(e.force){t();return}j({room:e.room,no(){a("roomNotFound")},yes(i){t()}})}function k(){r.log("RTCMC - updateExtraData called",n.extra),n.updateExtraData()}function I(e={}){if(r.log("RTCMC - publishFeed called",e),!e.stream)return;const t={...e};if(t.info){n.extra.streamsInfo[t.stream.id]=t.info,k();let i=t.info.from;R[i]={info:t.info,streamId:t.stream.id,stream:t.stream},window.setTimeout(()=>{n.addStream(t.stream)},2e3),i==="cam"&&t.stream.getAudioTracks().length&&V(t)}else n.addStream(t.stream)}function X(e={}){r.log("RTCMC - updatePublishedFeed called",e);const t={...e};let i=null,s=null;if(t.info&&(s=t.info.from,i=R[s],i)){const c=i.streamId;i.stream&&(t.existingStream=n.attachStreams.find(d=>d&&d.id===c)),n.extra.streamsInfo[c].mirroredVideo=t.info.mirroredVideo,k(),R[s].info.mirroredVideo=t.info.mirroredVideo}const o=t.existingStream;if(t.stream)if(r.log("RTCMC - updatePublishedFeed - has new stream"),o){r.log("RTCMC - updatePublishedFeed - has existing stream"),s==="cam"&&C&&C.stop();const c=t.stream.getAudioTracks(),d=t.stream.getVideoTracks(),P=o.getTracks();if(c.length||d.length){t.action!=="blur"&&t.action!=="unblur"&&P.forEach(b=>{b.enabled=!1,b.stop()}),p({event:"streamPaused",data:{id:o.id}}),t.action!=="blur"&&t.action!=="unblur"&&(o.paused=!0),I(t),c.length&&t.info&&t.info.from==="cam"&&V(t);return}else if(P.length){P.forEach(b=>{b.enabled=!1,b.stop()}),p({event:"streamTrackRemoved",data:{id:o.id},timeout:o.paused?2e3:0}),o.paused=!1;return}}else r.log("RTCMC - updatePublishedFeed - no existing stream"),I(t);else r.log("RTCMC - updatePublishedFeed - no new stream"),s==="cam"&&C&&C.stop(),o&&(r.log("RTCMC - updatePublishedFeed - has existing stream"),n.removeStream(o.id),o.getTracks().forEach(c=>{c.enabled=!1}),o.paused=!0,t.action==="remove"?p({event:"streamTrackRemoved",data:{id:o.id}}):p({event:"streamPaused",data:{id:o.id}}))}function L(e={}){r.log("RTCMC - close called",e),n&&(e.feeds&&e.feeds.length&&e.feeds.forEach(t=>{n.removeStream(t.stream.id),typeof t.stopFn=="function"?t.stopFn(t.stream):typeof t.stream.getTracks=="function"?t.stream.getTracks().forEach(i=>i.stop()):typeof t.stream.stop=="function"&&t.stream.stop()}),n.removeStream({video:!0,audio:!0}),n.attachStreams.forEach(t=>{n.removeStream(t.id),t.getTracks().forEach(i=>i.stop())}),n.attachStreams=[]),window.setTimeout(()=>{n.getAllParticipants().forEach(t=>{n.disconnectWith(t)}),n&&(n.leave(),n.closeSocket()),n=null,f=!1,R={},O={},M={},h=[],typeof e.callback=="function"&&e.callback()},500)}function Z(e={}){!e.file||!e.sendTo||n.shareFile(e.file,e.sendTo)}function $(e={}){return n.streamEvents.selectAll()}function V({stream:e,info:t}){!v.speechDetection||({...t},e.id,window.setTimeout(()=>{C=hark(e,{}),C.on("speaking",()=>{p({event:"speaking",data:{userId:n.userid,from:"cam"}})}),C.on("stopped_speaking",()=>{p({event:"stoppedSpeaking",data:{userId:n.userid,from:"cam"}})})},1e3))}function H(){if(!n)return;const e={streamTrackRemoved:ee,streamTrackUpdated:te,streamPaused:ne,remoteHandToggled:re,speaking:ie,stoppedSpeaking:oe,snapshotTaken:ae,meetingUpdated:se,meetingEnded:ce,userBanned:de,participantLeft:ue,toggleRemoteAV:le,pollPublished:me,pollResultPublished:fe};y().then(t=>{t.on("Connect-Whisper-"+m.uuid,i=>{!n||i&&e.hasOwnProperty(i.event)&&e[i.event](i.data)})}).catch(t=>{r.error(t)})}function u(){if(!n)return;const e=n.getAllParticipants(),t=[];return e.forEach((i,s)=>{const o=n.peers[i];o&&t.push({userId:o.userid,...o.extra})}),r.log("RTCMC - checkNumberOfParticipants - participants",t),a("participantsCountChecked",t),e.length}function l(e={}){if(!e)return;const t=e.extra?e.extra:{},i=e.id||e.streamid,s=e.userid||e.userId,o=t.user?t.user.uuid:null,c=i&&t.streamsInfo?t.streamsInfo[i]:{},d={userId:s,userUuid:o,...t};return i&&(d.id=i,d.key=o,d.isScreen=!1,d.isWhiteboard=!1,d.isTalking=!1),c&&(d.mirroredVideo=c.mirroredVideo||!1,d.info=c,c.from&&((c.from==="screen"||c.from==="whiteboard")&&(d.key=d.key+"-"+c.from),d.from=c.from,d.isScreen=c.from==="screen",d.isWhiteboard=c.from==="whiteboard",d.isTalking=c.from==="cam"&&c.talking)),e.stream&&(d.stream=e.stream),d}function ee(e){r.log("RTCMC - On onStreamTrackRemoved: ",e);const t=l(e);a("streamRemoved",{...t,kind:e.kind,info:e.info})}function te(e){r.log("RTCMC - On onStreamTrackUpdated: ",e);const t=l(e);a("streamUpdated",{...t,kind:e.kind,info:e.info})}function ne(e){r.log("RTCMC - On onStreamPaused: ",e);const t=l(e);a("streamUpdated",{...t,kind:e.kind,type:"paused",info:e.info})}function re(e){r.log("RTCMC - On onRemoteHandToggled: ",e);const t=l(e);a("remoteHandToggled",{...t,isHandUp:e.isHandUp})}function ie(e){const t=l(e);a("streamUpdated",{...t,from:e.from,type:"meta-updated",data:{key:"isTalking",value:!0}})}function oe(e){const t=l(e);a("streamUpdated",{...t,from:e.from,type:"meta-updated",data:{key:"isTalking",value:!1}})}function ae(e){r.log("RTCMC - On onSnapshotTaken: ",e),a("snapshotTaken",e)}function se(e){r.log("RTCMC - On onMeetingUpdated: ",e),a("meetingUpdated",e)}function ce(e){r.log("RTCMC - On onMeetingEnded: ",e),a("meetingEnded",e)}function de(e){r.log("RTCMC - On onUserBanned: ",e),u(),a("userBanned",e)}function ue(e){if(r.log("RTCMC - onParticipantLeft: ",e),!n)return;const t=l(e);!(t.userId||t.userUuid)||(a("participantLeft",t),window.setTimeout(u,1e3))}function le(e){r.log("RTCMC - On onToggleRemoteAV: ",e),(!e.userId||e.userId!==n.userid)&&a("toggleRemoteAV",e)}function me(e){r.log("RTCMC - On onPollPublished: ",e),a("pollPublished",e)}function fe(e){r.log("RTCMC - On onPollResultPublished: ",e),a("pollResultPublished",e)}function ge(e){r.log("RTCMC - On rtcmOnOpen: ",e),!M[e.userid]&&(M[e.userid]=!0,u(),a("dataChannelOpened",e))}function Ce({data:e,extra:t,userid:i}){if(r.log("RTCMC - On rtcmOnMessage: ",e,t,i),!!e){if(e.type==="whiteboard"){a("whiteboardMessageReceived",{userId:i,user:t==null?void 0:t.user,data:e.data});return}else if(e.type==="file-sharing"){a("fileSharingMessageReceived",{userId:i,user:t==null?void 0:t.user,data:e.data});return}a("messageReceived",{userId:i,user:t==null?void 0:t.user,data:e.data})}}function pe(e,t){if(r.log("RTCMC - On rtcmOnNewParticipant - participantId, userPreferences: ",e,t),!n||u()>=n.maxParticipantsAllowed)return;const i=t.connectionDescription.remoteUserId;n.acceptParticipationRequest(e,t),O[i]=!0,u(),r.log("RTCMC - On rtcmOnNewParticipant - auto accepted!")}function be(e){r.log("RTCMC - On onNumberOfBroadcastViewersUpdated: ",e),!(!n.isInitiator&&n.extra.isHost)&&a("numberOfBroadcastViewersUpdated",e.numberOfBroadcastViewers)}function Re(e){if(r.log("RTCMC - On rtcmOnStream: ",e),!n)return;const t=l(e);if(!n.peers[t.userId]){r.log("RTCMC - On rtcmOnStream - participant already gone!"),a("participantLeft",t),u();return}let i={...e.extra};if(!(i.user&&i.user.uuid)){r.log("RTCMC - On rtcmOnStream - Not enough data!");return}if(m.type.uuid==="live_class"&&!(n.isInitiator||n.extra.isHost)&&!(i.isInitiator||i.isHost)&&e.type==="remote"){r.log("RTCMC - On rtcmOnStream - Incoming stream is not from host! Dont show!");return}if((m.type.uuid==="webinar"||m.type.uuid==="podcast")&&!(n.isInitiator||n.extra.isHost)&&!(i.isInitiator||i.isHost)&&e.type==="remote"){if(n.enableScalableBroadcast){if(i.broadcasterExtra){let s={...i.broadcasterExtra};delete i.broadcasterExtra,i={...i,...s}}}else if(!e.extra.isInitiator&&!e.extra.isHost){r.log("RTCMC - On rtcmOnStream - Incoming stream is not from host! Dont show!");return}}if(n.enableScalableBroadcast){if((n.isInitiator||n.extra.isHost)&&e.type==="remote")return;n.isUpperUserLeft=!1,(e.extra.isInitiator||e.extra.isHost)&&(n.extra.broadcasterExtra={...i},k())}a("streamAdded",t),n.enableScalableBroadcast&&!n.isInitiator&&!n.isHost&&e.type==="remote"&&(n.dontCaptureUserMedia=!0,n.attachStreams=[e.stream],n.sdpConstraints.mandatory={OfferToReceiveAudio:!1,OfferToReceiveVideo:!1},n.getSocket(s=>{n.DetectRTC.browser.name==="Chrome"&&n.getAllParticipants().forEach(o=>{if(o+""!=e.userid+""){let c=n.peers[o].peer;c.getLocalStreams().forEach(d=>{c.removeStream(d)}),e.stream.getTracks().forEach(d=>{c.addTrack(d,e.stream)}),n.dontAttachStream=!0,n.renegotiate(o),n.dontAttachStream=!1}}),n.DetectRTC.browser.name==="Firefox"&&n.getAllParticipants().forEach(o=>{o+""!=e.userid+""&&n.replaceTrack(e.stream,o)}),n.DetectRTC.browser.name})),u()}function Te(e){if(r.log("RTCMC - On rtcmOnStreamEnded: ",e),!n)return;const t=l(e);if(!(t.user&&t.user.uuid)){r.log("RTCMC - On rtcmOnStreamEnded - Not enough data!");return}if(!n.peers[t.userId]){r.log("RTCMC - On rtcmOnStream - participant already gone!"),a("participantLeft",t),u();return}a("streamRemoved",t),u()}function Oe(e){r.log("RTCMC - On rtcmOnMediaError: ",e)}function Me(e){if(r.log("RTCMC - On rtcmOnError: ",e),!n)return;const t=l(e);!(t.userId||t.userUuid)||(a("participantLeft",t),window.setTimeout(u,1e3))}function he(e,t){r.log("RTCMC - On rtcmOnUserIdAlreadyTaken: "),n.userid=t}function Se(e){if(r.log("RTCMC - On rtcmOnExtraDataUpdated: ",e),!n)return;const t=l(e);if(!(t.userId||t.userUuid))return;if(!n.peers[t.userId]){r.log("RTCMC - On rtcmOnExtraDataUpdated - participant already gone!"),a("participantLeft",t),u();return}const i=h.findIndex(s=>s.userid===t.userId);i!==-1?(h.splice(i,1),a("participantJoined",t)):a("userInfoUpdated",t),u()}function ke(e){if(r.log("RTCMC - On rtcmOnUserStatusChanged - event : ",e),!n||!e.userid||!e.status)return;if(!(e.extra&&e.extra.user)){h.push(e);return}const t=l(e);!(t.userId||t.userUuid)||(e.status==="online"?a("participantJoined",t):a("participantLeft",t),window.setTimeout(u,1e3))}function ve(e){r.log("RTCMC - On rtcmOnSocketDisconnect: ",e),y().then(t=>{r.log("RTCMC - On rtcmOnSocketReconnect")}).catch(t=>{r.error(t)})}function ye(e){a("fileReceivingStart",{file:e})}function Ee(e){a("fileReceivingProgress",{chunk:e})}function je(e){a("fileReceivingEnd",{file:e})}return{init:N}}export{Je as default};
