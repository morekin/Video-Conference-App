import{l as Ue}from"../../index.d951cdc8.js";import{R as xe}from"../../hark.bundle.8af12079.js";import"../../vendor/vendor-webrtc-adapter.d803ee7d.js";import{h as Ce}from"../../hark.esm.e78be4e6.js";import"../../vendor/vendor-others.c8ba1624.js";import{L as Fe}from"../../logger.45fb8d96.js";import"../../vendor/vendor-laravel-echo.aae8cf55.js";import"../../vendor/vendor-core.3574f8d9.js";import"../../vendor/vendor-pusher-js.7eab09ad.js";import"../../app.a373aa59.js";import"../../vendor/vendor-essential.91b5cfa2.js";import"../../vendor/vendor-bootstrap-vue.17129278.js";import"../../vendor/vendor-vue-gtag.f8884558.js";let B=document.createElement("script");B.setAttribute("src","/js/EBML.js"),document.head.appendChild(B);window.io=Ue;function Ge(){const F=window.atob("aHR0cHM6Ly9zaWduYWx2Mi5rb2RlbWludC5pbjo5MDAyLw==");let n=null,l=!1,h={},S={debug:!1,iceServers:[],mediaServers:[],signalServer:F,opaqueId:"KMConnect",maxParticipants:1e3},f={},u={},E={},P={},k={},v={},O=[],T=[];const I=new Fe;let g=null;function W(){return n}function J(){var e;return(e=n.extra)==null?void 0:e.user}function N(){return n.userid}function A(e={}){j(R(e))}function q(e={}){e.callbacks&&(f=Object.assign(f,e.callbacks)),n.enableFileSharing=!0,n.chunkSize=15e3,n.onFileStart=we,n.onFileProgress=je,n.onFileEnd=Me}function z(e={}){const t=R(e),i=()=>{n.enableScalableBroadcast?(n.userid=t.room,n.connectSocket(o=>{o.emit("join-broadcast",{broadcastId:t.room,userid:n.userid,typeOfStreams:n.session})})):L(t)};n?i():(t.success=()=>{i()},j(t))}function G(e={}){const t=R(e),i=()=>{n.enableScalableBroadcast?n.connectSocket(o=>{o.emit("join-broadcast",{broadcastId:t.room,userid:n.userid,typeOfStreams:n.session})}):U(t)};n?i():(t.success=()=>{i()},j(t))}function K(e={}){n.userid,V({...e,callback:()=>{a("leftMeeting",T)}})}function p({event:e,type:t,data:i={},timeout:o=0,callback:r}){var s;if(n)if(e&&n.socket){e==="liveTranscription"&&!i.interim&&!i.final&&i.lastFinal&&u.canModerate&&T.push({user:(s=n.extra)==null?void 0:s.user,createdAt:i.createdAt,transcript:i.lastFinal});try{window.setTimeout(()=>{n.socket.emit("Connect-Whisper-"+u.uuid,{event:e,data:{userId:n.userid,extra:n.extra,...i}}),r&&_.isFunction(r)&&r()},o)}catch{}}else try{window.setTimeout(()=>{n.send({type:t,data:i}),r&&_.isFunction(r)&&r()},o)}catch{}}function Y({participantId:e,userId:t,userPreferences:i}){n.acceptParticipationRequest(e,i),k[t]=!0,d(),a("participantJoined",{participantId:e,userId:t,userPreferences:i})}function Q(e={}){var i,o;const t=R(e);Object.assign(n.extra,{user:{username:t.userObject.username,uuid:t.userObject.uuid,name:t.userObject.name,avatar:(i=t.userObject.profile)==null?void 0:i.avatar,cover:(o=t.userObject.profile)==null?void 0:o.cover},isHost:t.meeting.isHost,canModerate:t.meeting.canModerate,canToggleAudio:t.meetingConfigs.canToggleAudio,canToggleVideo:t.meetingConfigs.canToggleVideo,canHaveStream:t.meetingRules.sendAudio||t.meetingRules.sendVideo}),y()}function a(e,t){e&&f.hasOwnProperty(e)&&_.isFunction(f[e])&&f[e](t)}function R(e={}){const t={...e};return _.isObject(t.user)&&(t.userObject={...t.user},t.user=JSON.stringify(t.user)),t.user,t.config=Object.assign({},S,t.config),u=t.meeting?t.meeting:u,E=t.meetingConfigs?t.meetingConfigs:E,P=t.meetingRules?t.meetingRules:P,t}async function w(e){return await n.getSocket(t=>{if(t)return t;throw"RTCMC - Socket not found!"})}function j(e={}){var t,i;n||(T=[],n=new xe,n.socketURL=e.config.signalServer||F,n.iceServers=e.config.iceServers,n.autoCreateMediaElement=!1,n.enableLogs=e.config.debug,e.config.forceTurn&&(n.candidates={turn:!0,stun:!1,host:!1}),n.onopen=pe,n.onmessage=be,n.onNewParticipant=he,n.onNumberOfBroadcastViewersUpdated=Se,n.onstream=ke,n.onstreamended=ve,n.onMediaError=Oe,n.onerror=Te,n.onUserIdAlreadyTaken=Ie,n.onExtraDataUpdated=Re,n.onUserStatusChanged=ye,n.onSocketDisconnect=Ee,n.socketMessageEvent="Connect-Message-"+u.uuid,n.setCustomSocketEvent("Connect-Whisper-"+u.uuid),k={},v={},n.maxParticipantsAllowed=e.config.maxParticipants,n.mediaConstraints={video:!1,audio:!1,screen:!1},n.dontCaptureUserMedia=!0,e.meetingRules?(n.session=e.meetingRules.session,n.sdpConstraints.mandatory={OfferToReceiveAudio:e.meetingRules.receiveAudio,OfferToReceiveVideo:e.meetingRules.receiveVideo},e.meetingRules.session.oneway&&(n.enableScalableBroadcast=!0,n.autoCloseEntireSession=!0,n.maxRelayLimitPerUser=1,n.socketMessageEvent="scalable-media-broadcast-demo",n.connectSocket(o=>{o.on("join-broadcaster",r=>{n.session=r.typeOfStreams,n.sdpConstraints.mandatory={OfferToReceiveVideo:!!n.session.video,OfferToReceiveAudio:!!n.session.audio},n.broadcastId=r.broadcastId,U({room:r.userid,force:!0})}),o.on("rejoin-broadcast",r=>{n.attachStreams=[],o.emit("check-broadcast-presence",r,s=>{s?o.emit("join-broadcast",{broadcastId:r,userid:n.userid,typeOfStreams:n.session}):e.meeting.canModerate?(n.userid=r,o.emit("join-broadcast",{broadcastId:r,userid:n.userid,typeOfStreams:n.session})):a("roomNotFound")})}),o.on("broadcast-stopped",r=>{a("broadcastStopped",r)}),o.on("start-broadcasting",r=>{u.canModerate?(n.sdpConstraints.mandatory={OfferToReceiveVideo:!1,OfferToReceiveAudio:!1},n.session=r,L({room:n.userid,force:!0})):a("roomNotFound")})}))):e.meetingRules={},e.userObject||(e.userObject={...e.user},e.user=JSON.stringify(e.user)),n.extra={user:{username:e.userObject.username,uuid:e.userObject.uuid,name:e.userObject.name,avatar:(t=e.userObject.profile)==null?void 0:t.avatar,cover:(i=e.userObject.profile)==null?void 0:i.cover},isInitiator:!1,isHost:e.meeting.isHost,canModerate:e.meeting.canModerate,canToggleAudio:e.meetingConfigs.canToggleAudio,canToggleVideo:e.meetingConfigs.canToggleVideo,canHaveStream:e.meetingRules.sendAudio||e.meetingRules.sendVideo,broadcastId:e.room,streamsInfo:{}},a("sessionCreated"),d(),_.isFunction(e.success)&&e.success())}function M(e={}){n?n.enableScalableBroadcast?w().then(t=>{t.emit("check-broadcast-presence",e.room,i=>{i===!0?_.isFunction(e.yes)&&e.yes(t):_.isFunction(e.no)&&e.no(t)})}).catch(t=>{I.error(t),_.isFunction(e.no)&&e.no(t)}):n.checkPresence(e.room,(t,i)=>{t===!0?_.isFunction(e.yes)&&e.yes():_.isFunction(e.no)&&e.no()}):_.isFunction(e.no)&&e.no()}function L(e={}){const t=()=>{l||(n.extra.isInitiator=!0,n.open(e.room,(i,o,r)=>{l=!1,r?a("createRoomError",r):i===!0&&(l=!0,a("roomCreated",o),D())}))};e.force?t():M({room:e.room,no(i){t()},yes(){U({...e,force:!0})}})}function U(e={}){const t=()=>{l||n.join(e.room,(i,o,r)=>{l=!1,i===!1||r?a(r==="Room full"?"roomFullError":"joinRoomError",r):(l=!0,d(),D(),a("roomJoined",o))})};e.force?t():M({room:e.room,no(){a("roomNotFound")},yes(i){t()}})}function y(){n.updateExtraData()}function x(e={}){if(!e.stream)return;const t={...e};if(t.info){n.extra.streamsInfo[t.stream.id]=t.info,y();let i=t.info.from;h[i]={info:t.info,streamId:t.stream.id,stream:t.stream},window.setTimeout(()=>{n.addStream(t.stream)},2e3),i==="cam"&&t.stream.getAudioTracks().length&&H(t)}else n.addStream(t.stream)}function X(e={}){const t={...e};let i=null,o=null;if(t.info&&(o=t.info.from,i=h[o],i)){const s=i.streamId;i.stream&&(t.existingStream=n.attachStreams.find(c=>c&&c.id===s)),n.extra.streamsInfo[s].mirroredVideo=t.info.mirroredVideo,y(),h[o].info.mirroredVideo=t.info.mirroredVideo}const r=t.existingStream;if(t.stream)if(r){o==="cam"&&g&&g.stop();const s=t.stream.getAudioTracks(),c=t.stream.getVideoTracks(),C=r.getTracks();if(s.length||c.length)return t.action!=="blur"&&t.action!=="unblur"&&C.forEach(b=>{b.enabled=!1,b.stop()}),p({event:"streamPaused",data:{id:r.id}}),t.action!=="blur"&&t.action!=="unblur"&&(r.paused=!0),x(t),void(s.length&&t.info&&t.info.from==="cam"&&H(t));if(C.length)return C.forEach(b=>{b.enabled=!1,b.stop()}),p({event:"streamTrackRemoved",data:{id:r.id},timeout:r.paused?2e3:0}),void(r.paused=!1)}else x(t);else o==="cam"&&g&&g.stop(),r&&(n.removeStream(r.id),r.getTracks().forEach(s=>{s.enabled=!1}),r.paused=!0,t.action==="remove"?p({event:"streamTrackRemoved",data:{id:r.id}}):p({event:"streamPaused",data:{id:r.id}}))}function V(e={}){n&&(e.feeds&&e.feeds.length&&e.feeds.forEach(t=>{n.removeStream(t.stream.id),typeof t.stopFn=="function"?t.stopFn(t.stream):typeof t.stream.getTracks=="function"?t.stream.getTracks().forEach(i=>i.stop()):typeof t.stream.stop=="function"&&t.stream.stop()}),n.removeStream({video:!0,audio:!0}),n.attachStreams.forEach(t=>{n.removeStream(t.id),t.getTracks().forEach(i=>i.stop())}),n.attachStreams=[]),window.setTimeout(()=>{n.getAllParticipants().forEach(t=>{n.disconnectWith(t)}),n&&(n.leave(),n.closeSocket()),n=null,l=!1,h={},k={},v={},O=[],typeof e.callback=="function"&&e.callback()},500)}function Z(e={}){e.file&&e.sendTo&&n.shareFile(e.file,e.sendTo)}function $(e={}){return n.streamEvents.selectAll()}function H({stream:e,info:t}){!E.speechDetection||(e.id,window.setTimeout(()=>{g=Ce(e,{}),g.on("speaking",()=>{p({event:"speaking",data:{userId:n.userid,from:"cam"}})}),g.on("stopped_speaking",()=>{p({event:"stoppedSpeaking",data:{userId:n.userid,from:"cam"}})})},1e3))}function D(){if(!n)return;const e={streamTrackRemoved:ee,streamTrackUpdated:te,streamPaused:ne,remoteHandToggled:ie,speaking:re,stoppedSpeaking:ae,snapshotTaken:oe,meetingUpdated:se,meetingEnded:ce,userBanned:de,participantLeft:ue,toggleRemoteAV:me,pollPublished:le,pollResultPublished:fe,liveTranscription:ge};w().then(t=>{t.on("Connect-Whisper-"+u.uuid,i=>{n&&i&&e.hasOwnProperty(i.event)&&e[i.event](i.data)})}).catch(t=>{I.error(t)})}function d(){if(!n)return;const e=n.getAllParticipants(),t=[];return e.forEach((i,o)=>{const r=n.peers[i];r&&t.push({userId:r.userid,...r.extra})}),a("participantsCountChecked",t),e.length}function m(e={}){if(!e)return;const t=e.extra?e.extra:{},i=e.id||e.streamid,o=e.userid||e.userId,r=t.user?t.user.uuid:null,s=i&&t.streamsInfo?t.streamsInfo[i]:{},c={userId:o,userUuid:r,...t};return i&&(c.id=i,c.key=r,c.isScreen=!1,c.isWhiteboard=!1,c.isTalking=!1),s&&(c.mirroredVideo=s.mirroredVideo||!1,c.info=s,s.from&&(s.from!=="screen"&&s.from!=="whiteboard"||(c.key=c.key+"-"+s.from),c.from=s.from,c.isScreen=s.from==="screen",c.isWhiteboard=s.from==="whiteboard",c.isTalking=s.from==="cam"&&s.talking)),e.stream&&(c.stream=e.stream),c}function ee(e){a("streamRemoved",{...m(e),kind:e.kind,info:e.info})}function te(e){a("streamUpdated",{...m(e),kind:e.kind,info:e.info})}function ne(e){a("streamUpdated",{...m(e),kind:e.kind,type:"paused",info:e.info})}function ie(e){a("remoteHandToggled",{...m(e),isHandUp:e.isHandUp})}function re(e){a("streamUpdated",{...m(e),from:e.from,type:"meta-updated",data:{key:"isTalking",value:!0}})}function ae(e){a("streamUpdated",{...m(e),from:e.from,type:"meta-updated",data:{key:"isTalking",value:!1}})}function oe(e){a("snapshotTaken",e)}function se(e){a("meetingUpdated",e)}function ce(e){a("meetingEnded",e)}function de(e){d(),a("userBanned",e)}function ue(e){if(!n)return;const t=m(e);(t.userId||t.userUuid)&&(a("participantLeft",t),window.setTimeout(d,1e3))}function me(e){e.userId&&e.userId===n.userid||a("toggleRemoteAV",e)}function le(e){a("pollPublished",e)}function fe(e){a("pollResultPublished",e)}function ge(e){var t,i,o;!e.interim&&!e.final&&e.lastFinal&&u.canModerate&&T.push({user:(t=e.event.extra)==null?void 0:t.user,createdAt:e.createdAt,transcript:e.lastFinal}),a("transcriptUpdated",{userId:e.event.userId,userUuid:e.event.extra.user.uuid,from:"cam",type:"transcript-updated",interim:(i=e.interim)!=null?i:"",final:(o=e.final)!=null?o:""})}function pe(e){v[e.userid]||(v[e.userid]=!0,d(),a("dataChannelOpened",e))}function be({data:e,extra:t,userid:i}){e&&(e.type!=="whiteboard"?e.type!=="file-sharing"?a("messageReceived",{userId:i,user:t==null?void 0:t.user,data:e.data}):a("fileSharingMessageReceived",{userId:i,user:t==null?void 0:t.user,data:e.data}):a("whiteboardMessageReceived",{userId:i,user:t==null?void 0:t.user,data:e.data}))}function he(e,t){if(!n||d()>=n.maxParticipantsAllowed)return;const i=t.connectionDescription.remoteUserId;n.acceptParticipationRequest(e,t),k[i]=!0,d()}function Se(e){!n.isInitiator&&n.extra.isHost||a("numberOfBroadcastViewersUpdated",e.numberOfBroadcastViewers)}function ke(e){if(!n)return;const t=m(e);if(!n.peers[t.userId])return a("participantLeft",t),void d();let i={...e.extra};if(i.user&&i.user.uuid&&(u.type.uuid!=="live_class"||n.isInitiator||n.extra.isHost||i.isInitiator||i.isHost||e.type!=="remote")){if(!(u.type.uuid!=="webinar"&&u.type.uuid!=="podcast"||n.isInitiator||n.extra.isHost||i.isInitiator||i.isHost||e.type!=="remote")){if(n.enableScalableBroadcast){if(i.broadcasterExtra){let o={...i.broadcasterExtra};delete i.broadcasterExtra,i={...i,...o}}}else if(!e.extra.isInitiator&&!e.extra.isHost)return}if(n.enableScalableBroadcast){if((n.isInitiator||n.extra.isHost)&&e.type==="remote")return;n.isUpperUserLeft=!1,(e.extra.isInitiator||e.extra.isHost)&&(n.extra.broadcasterExtra={...i},y())}a("streamAdded",t),!n.enableScalableBroadcast||n.isInitiator||n.isHost||e.type!=="remote"||(n.dontCaptureUserMedia=!0,n.attachStreams=[e.stream],n.sdpConstraints.mandatory={OfferToReceiveAudio:!1,OfferToReceiveVideo:!1},n.getSocket(o=>{n.DetectRTC.browser.name==="Chrome"&&n.getAllParticipants().forEach(r=>{if(r+""!=e.userid+""){let s=n.peers[r].peer;s.getLocalStreams().forEach(c=>{s.removeStream(c)}),e.stream.getTracks().forEach(c=>{s.addTrack(c,e.stream)}),n.dontAttachStream=!0,n.renegotiate(r),n.dontAttachStream=!1}}),n.DetectRTC.browser.name==="Firefox"&&n.getAllParticipants().forEach(r=>{r+""!=e.userid+""&&n.replaceTrack(e.stream,r)}),n.DetectRTC.browser.name})),d()}}function ve(e){if(!n)return;const t=m(e);if(t.user&&t.user.uuid){if(!n.peers[t.userId])return a("participantLeft",t),void d();a("streamRemoved",t),d()}}function Oe(e){}function Te(e){if(!n)return;const t=m(e);(t.userId||t.userUuid)&&(a("participantLeft",t),window.setTimeout(d,1e3))}function Ie(e,t){n.userid=t}function Re(e){if(!n)return;const t=m(e);if(!t.userId&&!t.userUuid)return;if(!n.peers[t.userId])return a("participantLeft",t),void d();const i=O.findIndex(o=>o.userid===t.userId);i!==-1?(O.splice(i,1),a("participantJoined",t)):a("userInfoUpdated",t),d()}function ye(e){if(!n||!e.userid||!e.status)return;if(!e.extra||!e.extra.user)return void O.push(e);const t=m(e);(t.userId||t.userUuid)&&(e.status==="online"?a("participantJoined",t):a("participantLeft",t),window.setTimeout(d,1e3))}function Ee(e){w().then(t=>{}).catch(t=>{I.error(t)})}function we(e){a("fileReceivingStart",{file:e})}function je(e){a("fileReceivingProgress",{chunk:e})}function Me(e){a("fileReceivingEnd",{file:e})}return{init:async function(e={}){if(!e.config)throw"RTC Library config not defined!";return S=Object.assign(S,e.config),e.callbacks&&(f=Object.assign(f,e.callbacks)),I.setDebug(S.debug),!n&&e.options&&A({...e.options}),{getInstance:W,getUserInfo:J,getInstanceUserId:N,initSession:A,setupFileSharing:q,startMeeting:z,joinMeeting:G,leaveMeeting:K,publishFeed:x,updatePublishedFeed:X,sendMessage:p,acceptJoiningRequest:Y,roomExists:M,close:V,shareFile:Z,getAllStreams:$,updateSessionOptions:Q}}}}export{Ge as default};
