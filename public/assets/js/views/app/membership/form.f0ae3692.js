import{f as n}from"../../../form.90751a24.js";import{m as o,i as l}from"../../../vendor/vendor-core.3574f8d9.js";import{S as d}from"../../../index.4c16d3b9.js";import{n as p}from"../../../_plugin-vue2_normalizer.7b9a2fe2.js";import{h as m,i as c,j as u}from"../../../vendor/vendor-bootstrap-vue.17129278.js";import"../../../header.43f859fb.js";import"../../../app.a373aa59.js";import"../../../vendor/vendor-others.c8ba1624.js";import"../../../vendor/vendor-essential.91b5cfa2.js";import"../../../vendor/vendor-vue-gtag.f8884558.js";import"../../../FileUploader.78ddb8c0.js";import"../../../uploader.da0c2632.js";import"../../../event-bus.6a5776a8.js";import"../../../momentz.ae4aeebe.js";const h={extends:n,components:{StripeElementCard:d,BCard:m,BTabs:c,BTab:u},data(){return{formData:{frequency:null,currency:null,amount:0,payableAmount:0,creditBalance:0,applicableDate:null,oldExpiryDate:null,expiryDate:null,source:null,token:null,charge:null,orgName:"",addressLine1:"",addressLine2:"",city:"",state:"",country:"",zipcode:"",meta:{}},formLabels:{frequency:$t("membership.props.frequency"),currency:$t("config.system.currency"),amount:$t("membership.props.amount"),payableAmount:$t("membership.props.payable_amount"),creditBalance:$t("membership.props.credit_balance"),expiryDate:$t("membership.props.expiry_date"),newExpiryDate:$t("membership.props.new_expiry_date"),applicableDate:$t("membership.props.applicable_date"),orgName:$t("membership.props.org_name"),addressLine1:$t("membership.props.address_line_1"),addressLine2:$t("membership.props.address_line_2"),city:$t("membership.props.city"),state:$t("membership.props.state"),country:$t("membership.props.country"),zipcode:$t("membership.props.zipcode")},showPaymentOptions:!0,initialSetupCompleted:!1,paypalConfig:{loaded:!1},paypalButtons:null,paypalButtonsHasRendered:!1,paddleConfig:{loaded:!1},flutterwaveConfig:{loaded:!1},activePGTab:0,loading:!1,pageTitle:$t("membership.start_membership"),initUrl:"membership"}},computed:{...o("common",["entity"]),...o("user",{userUuid:"uuid"}),...o("user",["hasActiveMembership","membershipExpiryDate","hasLifetimeMembership","email","name"]),preRequisiteEntity(){return this.entity},isBusy(){return!!(!this.entity||this.isLoading)},computedFrequency:{get(){return this.formData.frequency?this.formData.frequency.name:null},set(i){this.formData.frequency=this.preRequisiteEntity.frequencies.find(e=>e.name===i),this.getCalculatedAmount()}},computedCurrency:{get(){return this.formData.currency?this.formData.currency.name:null},set(i){this.formData.currency=this.preRequisiteEntity.currencies.find(a=>a.name===i),this.getCalculatedAmount();const e=this.preRequisiteEntity.paymentGateways,t=e[this.computedActiveTab];e.length&&(t.name==="paypal"?this.paypalConfig.loaded===!0?this.paypalScriptLoaded():this.loadPaypal():t.name==="paddle"?this.paddleConfig.loaded===!0?this.paddleScriptLoaded():this.loadPaddle():t.name==="flutterwave"&&(this.flutterwaveConfig.loaded===!0?this.flutterwaveScriptLoaded():this.loadFlutterwave()))}},stripeFactor(){return this.computedCurrency&&this.computedCurrency.stripeFactor?this.computedCurrency.stripeFactor:100},computedPricingForPaddle(){return[this.computedCurrency?`${this.computedCurrency}:${this.payableAmount}`:`USD:${this.payableAmount}`]},stripeConfig(){return this.entity&&this.entity.paymentGateways.length?this.entity.paymentGateways[0]:{}},stripeStyle(){return{empty:{"::placeholder":{color:"#adb5c0"},":focus":{"::placeholder":{color:"#ced4dd"}}}}},payableAmount(){return this.formData.amount},computedActiveTab:{get(){return this.activePGTab===-1?0:this.activePGTab},set(i){if(this.activePGTab=i===-1?0:i,i!==-1){const e=this.preRequisiteEntity.paymentGateways,t=e[i];e.length&&t.name==="paypal"?this.paypalConfig.loaded===!1?this.loadPaypal():this.paypalScriptLoaded():(this.paypalConfig.loaded&&this.paypalButtons&&this.paypalButtons.close&&(this.paypalButtons.close(),this.paypalButtonsHasRendered=!1),e.length&&(t.name==="paddle"?this.paddleConfig.loaded===!1?this.loadPaddle():this.paddleScriptLoaded():t.name==="flutterwave"&&(this.flutterwaveConfig.loaded===!1?this.loadFlutterwave():this.flutterwaveScriptLoaded())))}}},computedActiveTabName(){return this.preRequisiteEntity&&this.preRequisiteEntity.paymentGateways&&this.preRequisiteEntity.paymentGateways[this.computedActiveTab]?this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name:null}},watch:{preRequisiteEntity(i){i&&(this.formData.frequency=i.frequencies?i.frequencies[0]:null)}},methods:{...l("user",["GetUser"]),getCalculatedAmount(i){!this.initialSetupCompleted||(this.isLoading=!0,this.formData.method=this.preRequisiteEntity&&this.preRequisiteEntity.paymentGateways&&this.preRequisiteEntity.paymentGateways.length?this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name:null,this.Custom({url:"membership/calculate",method:"post",data:this.formData}).then(e=>{this.formData.amount=e.amount||0,this.formData.applicableDate=e.applicableDate,this.formData.oldExpiryDate=e.expiryDate,this.formData.expiryDate=e.newExpiryDate,this.formData.paddleUrl=e.paddleUrl,this.isLoading=!1,i&&_.isFunction(i)?i():this.preRequisiteEntity&&this.preRequisiteEntity.paymentGateways.length&&(this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name==="paddle"?this.paddleConfig.loaded===!0?this.paddleScriptLoaded():this.loadPaddle():this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name==="flutterwave"&&(this.flutterwaveConfig.loaded===!0?this.flutterwaveScriptLoaded():this.loadFlutterwave()))}).catch(e=>{this.isLoading=!1,formUtil.handleErrors(e)}))},updateMembership(){this.isLoading=!0,this.Custom({url:"membership",method:"post",data:this.formData}).then(i=>{this.$toasted.success(i.message,this.$toastConfig),this.GetUser().then(e=>{this.$router.push({name:"appMembershipList",query:{reload:!0}}),this.isLoading=!1}).catch(e=>{formUtil.handleErrors(e),this.$router.push({name:"appMembershipList",query:{reload:!0}}),this.isLoading=!1})}).catch(i=>{this.isLoading=!1,formUtil.handleErrors(i)})},proceed(){this.formData.amount?(this.isLoading=!0,this.$refs&&this.preRequisiteEntity.paymentGateways.length?this.$refs.stripeRef&&this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name==="stripe"?this.$refs.stripeRef[0].submit():this.$refs.flutterwaveRef&&this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name==="flutterwave"?this.payWithFlutterwave():this.isLoading=!1:this.isLoading=!1):this.updateMembership()},stripeTokenCreated(i){this.formData.token=i,this.formData.method=this.preRequisiteEntity.paymentGateways.length&&this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name,this.formData.charge={source:i.id,amount:this.payableAmount*this.stripeFactor},this.formData.payableAmount=this.formData.charge.amount,this.updateMembership()},paypalScriptLoaded(){this.loading=!0,this.isLoading=!0,this.paypalButtons&&this.paypalButtons.close&&this.paypalButtonsHasRendered&&(this.paypalButtons.close(),this.paypalButtonsHasRendered=!1),this.paypalButtons=window.paypal.Buttons({createOrder:(i,e)=>{this.isLoading=!0;const t={purchase_units:[{description:`${window.kmenv.name} - ${this.computedFrequency.name} ${$t("membership.membership")}`,amount:{currency_code:this.computedCurrency,value:this.payableAmount}}]};return e.order.create(t)},onApprove:async(i,e)=>{const t=await e.order.capture();this.formData.token=t,this.formData.method=this.preRequisiteEntity.paymentGateways.length?this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name:null,this.formData.charge={source:t.id,amount:this.payableAmount},this.formData.payableAmount=this.formData.charge.amount,this.isLoading=!1,this.updateMembership()},onError:i=>{this.isLoading=!1,this.$toasted.error(this.$t("membership.paypal_create_order_error"),this.$toastConfig.error)}}),this.paypalButtons.render(this.$refs.paypalRef[0]).then(()=>{this.paypalButtonsHasRendered=!0}).catch(i=>{let e=this.$refs.paypalRef[0];if(e&&e.children.length>0)throw new Error(i);this.$toasted.info($t("general.kindly_reload_page"),this.$toastConfig.info)}),this.paypalConfig.loaded=!0,this.loading=!1,this.isLoading=!1},paddleScriptLoaded(){Paddle&&(this.paddleConfig.mode||Paddle.Environment.set("sandbox"),Paddle.Setup({vendor:this.paddleConfig.key}),this.getCalculatedAmount(()=>{Paddle.Checkout.open({method:"inline",email:this.email,country:this.formData.country,postcode:this.formData.zipcode,allowQuantity:!1,disableLogout:!0,frameTarget:"paddle-container",frameInitialHeight:416,frameStyle:"width:100%; min-width:312px; background-color: transparent; border: none;",override:this.formData.paddleUrl,successCallback:i=>{this.formData.token=i.checkout,this.formData.method=this.preRequisiteEntity.paymentGateways.length&&this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name,this.formData.charge={source:i.checkout.id,amount:this.payableAmount},this.formData.payableAmount=this.formData.charge.amount,this.updateMembership()}}),this.paddleConfig.loaded=!0}))},flutterwaveScriptLoaded(){this.isLoading=!1,FlutterwaveCheckout&&(this.flutterwaveConfig.loaded=!0)},payWithFlutterwave(){if(FlutterwaveCheckout){const i=this;this.getCalculatedAmount(()=>{var t,a,s;const e=FlutterwaveCheckout({public_key:this.flutterwaveConfig.key,tx_ref:`${$t("membership")}-${this.generateReference()}`,amount:this.payableAmount,currency:this.computedCurrency,payment_options:"card, account, mpesa, mobilemoneyghana, ussd, credit",meta:{meeting_uuid:this.entity.uuid,user_uuid:this.userUuid},customer:{email:this.email,name:this.formData.userName},customizations:{title:(t=this.configs.basic)==null?void 0:t.appName,logo:location.origin+((a=this.configs.assets)==null?void 0:a.icon),description:(s=this.configs.basic)==null?void 0:s.desc},callback(r){i.formData.token=r.tx_ref,Object.assign(i.formData.meta,r),i.formData.method=i.preRequisiteEntity.paymentGateways.length&&i.preRequisiteEntity.paymentGateways[i.computedActiveTab].name,i.formData.charge={source:r.transaction_id,amount:i.payableAmount},i.formData.payableAmount=i.formData.charge.amount,i.updateMembership(),e.close()},onclose(r){r===!0&&(this.isLoading=!1)}})})}},generateReference(){return new Date().getTime().toString()},loadJsFile(i,e,t){const a=document.createElement("script");a.src=i,a.addEventListener("load",e),t?t.appendChild(a):document.body.appendChild(a)},loadPaypal(){this.loadJsFile("https://www.paypal.com/sdk/js?client-id="+this.paypalConfig.key+"&currency="+this.computedCurrency,this.paypalScriptLoaded)},loadPaddle(){this.loadJsFile("https://cdn.paddle.com/paddle/paddle.js",this.paddleScriptLoaded)},loadFlutterwave(){this.loadJsFile("https://checkout.flutterwave.com/v3.js",this.flutterwaveScriptLoaded)}},mounted(){if(this.hasActiveMembership?this.pageTitle=$t("membership.extend_membership"):this.pageTitle=this.membershipExpiryDate?$t("membership.renew_membership"):$t("membership.start_membership"),this.applyPageHeader(),this.formData.currency=this.configs.system.currency,this.formData.orgName=this.configs.basic.orgName||"",this.formData.addressLine1=this.configs.basic.orgAddressLine1||"",this.formData.addressLine2=this.configs.basic.orgAddressLine2||"",this.formData.city=this.configs.basic.orgCity||"",this.formData.state=this.configs.basic.orgState||"",this.formData.country=this.configs.basic.orgCountry||"",this.formData.zipcode=this.configs.basic.orgZipcode||"",this.preRequisiteEntity){if(this.formData.frequency=this.preRequisiteEntity.selectedFrequency?this.preRequisiteEntity.selectedFrequency:this.preRequisiteEntity.frequencies?this.preRequisiteEntity.frequencies[0]:null,this.formData.currency=this.preRequisiteEntity.selectedCurrency?this.preRequisiteEntity.selectedCurrency:this.preRequisiteEntity.currencies?this.preRequisiteEntity.currencies[0]:null,this.preRequisiteEntity.paymentGateways.length){const i=this.preRequisiteEntity.paymentGateways.find(a=>a.name==="paypal");i&&(Object.assign(this.paypalConfig,i),this.paypalConfig.loaded=!1,this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name==="paypal"&&this.loadPaypal());const e=this.preRequisiteEntity.paymentGateways.find(a=>a.name==="paddle");e&&(Object.assign(this.paddleConfig,e),this.paddleConfig.loaded=!1,this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name==="paddle"&&this.loadPaddle());const t=this.preRequisiteEntity.paymentGateways.find(a=>a.name==="flutterwave");t&&(Object.assign(this.flutterwaveConfig,t),this.flutterwaveConfig.loaded=!1,this.preRequisiteEntity.paymentGateways[this.computedActiveTab].name==="flutterwave"&&this.loadFlutterwave())}this.initialSetupCompleted=!0,window.setTimeout(()=>{this.getCalculatedAmount()},1e3)}else this.initialSetupCompleted=!0}};var f=function(){var e=this,t=e._self._c;return t("base-container",{attrs:{boxed:"","min-height":"full","has-form":"","has-footer":""}},[t("form",{on:{submit:function(a){return a.preventDefault(),e.proceed.apply(null,arguments)}}},[t("animated-loader",{attrs:{"is-loading":e.isBusy,"loader-color":e.vars.loaderColor}}),e.entity?[t("div",{staticClass:"row"},[t("div",{staticClass:"col-12 col-md-4 mb-4"},[t("label",{staticClass:"d-block text-muted"},[e._v(e._s(e.formLabels.currency))]),t("div",[e._v(" "+e._s(e.computedCurrency)+" ")])]),t("div",{staticClass:"col-12 col-md-4 mb-4 text-md-center"},[t("label",{staticClass:"d-block text-muted"},[e._v(e._s(e.formLabels.frequency))]),t("div",{staticClass:"d-flex align-items-center justify-content-md-center flex-wrap"},[e._l(e.preRequisiteEntity.frequencies,function(a){return[t("base-radio",{key:a.name,staticClass:"mr-3 ml-0 mt-2",attrs:{value:a.name,inline:""},model:{value:e.computedFrequency,callback:function(s){e.computedFrequency=s},expression:"computedFrequency"}},[e._v(" "+e._s(a.name)+" ")])]})],2)]),t("div",{staticClass:"col-12 col-md-4 mb-4 mt-2 text-md-right"},[t("view-date",{attrs:{label:e.formLabels.expiryDate,value:e.formData.oldExpiryDate}})],1),t("div",{staticClass:"col-12 col-md-4 mb-4 mt-2 d-none d-lg-block"}),t("div",{staticClass:"col-12 col-md-4 mb-4 mt-2 text-md-center"},[t("view-date",{attrs:{label:e.formLabels.applicableDate,value:e.formData.applicableDate}})],1),t("div",{staticClass:"col-12 col-md-4 mb-4 mt-2 text-md-right"},[t("view-date",{attrs:{label:e.formLabels.newExpiryDate,value:e.formData.expiryDate}})],1)]),e.formData.currency&&e.formData.frequency?t("div",{staticClass:"mb-4 mt-2"},[t("div",{staticClass:"text-md-right"},[t("view-currency",{attrs:{label:e.formLabels.amount,value:e.formData.amount,currency:e.formData.currency,tag:"h5","data-classes":"text-success"}})],1),t("div",{staticClass:"text-md-right"},[t("view-currency",{attrs:{label:e.formLabels.payableAmount,value:e.payableAmount,currency:e.formData.currency,tag:"h2","data-classes":"text-success font-weight-600"}})],1)]):e._e(),t("h5",{staticClass:"mb-2 mt-1 pb-2 border-bottom"},[e._v(e._s(e.$t("membership.props.billing_address")))]),t("div",{staticClass:"row"},[t("div",{staticClass:"col-12"},[t("base-input",{attrs:{label:e.formLabels.orgName,type:"text",error:e.formErrors.orgName},on:{"update:error":function(a){return e.$set(e.formErrors,"orgName",a)}},model:{value:e.formData.orgName,callback:function(a){e.$set(e.formData,"orgName",a)},expression:"formData.orgName"}})],1),t("div",{staticClass:"col-12 col-md-4"},[t("base-input",{attrs:{label:e.formLabels.addressLine1,type:"text",error:e.formErrors.addressLine1},on:{"update:error":function(a){return e.$set(e.formErrors,"addressLine1",a)}},model:{value:e.formData.addressLine1,callback:function(a){e.$set(e.formData,"addressLine1",a)},expression:"formData.addressLine1"}})],1),t("div",{staticClass:"col-12 col-md-4"},[t("base-input",{attrs:{label:e.formLabels.addressLine2,type:"text",error:e.formErrors.addressLine2},on:{"update:error":function(a){return e.$set(e.formErrors,"addressLine2",a)}},model:{value:e.formData.addressLine2,callback:function(a){e.$set(e.formData,"addressLine2",a)},expression:"formData.addressLine2"}})],1),t("div",{staticClass:"col-12 col-md-4"},[t("base-input",{attrs:{label:e.formLabels.city,type:"text",error:e.formErrors.city},on:{"update:error":function(a){return e.$set(e.formErrors,"city",a)}},model:{value:e.formData.city,callback:function(a){e.$set(e.formData,"city",a)},expression:"formData.city"}})],1),t("div",{staticClass:"col-12 col-md-4"},[t("base-input",{attrs:{label:e.formLabels.state,type:"text",error:e.formErrors.state},on:{"update:error":function(a){return e.$set(e.formErrors,"state",a)}},model:{value:e.formData.state,callback:function(a){e.$set(e.formData,"state",a)},expression:"formData.state"}})],1),t("div",{staticClass:"col-12 col-md-4"},[t("base-input",{attrs:{label:e.formLabels.country,type:"text",error:e.formErrors.country},on:{"update:error":function(a){return e.$set(e.formErrors,"country",a)}},model:{value:e.formData.country,callback:function(a){e.$set(e.formData,"country",a)},expression:"formData.country"}})],1),t("div",{staticClass:"col-12 col-md-4"},[t("base-input",{attrs:{label:e.formLabels.zipcode,type:"text",error:e.formErrors.zipcode},on:{"update:error":function(a){return e.$set(e.formErrors,"zipcode",a)}},model:{value:e.formData.zipcode,callback:function(a){e.$set(e.formData,"zipcode",a)},expression:"formData.zipcode"}})],1)]),t("br"),e.showPaymentOptions?t("div",[t("b-card",{attrs:{"no-body":""}},[t("b-tabs",{attrs:{pills:"",card:"",vertical:"",lazy:"","active-nav-item-class":"font-weight-bold py-2","nav-wrapper-class":"col-12 col-md-4 col-lg-3 border-right"},model:{value:e.computedActiveTab,callback:function(a){e.computedActiveTab=a},expression:"computedActiveTab"}},e._l(e.entity.paymentGateways,function(a){return t("b-tab",{key:a.name,attrs:{title:a.label,"title-item-class":"p-0"}},[a.name==="stripe"?t("stripe-element-card",{ref:"stripeRef",refInFor:!0,attrs:{pk:e.stripeConfig.key,amount:e.payableAmount*e.stripeFactor,locale:e.configs.system.locale,"style-object":e.stripeStyle},on:{token:e.stripeTokenCreated,loading:function(s){e.loading=s}}}):e._e(),a.name==="paypal"?t("div",{ref:"paypalRef",refInFor:!0},[t("animated-loader",{attrs:{"is-loading":!e.paypalConfig.loaded&&!e.isBusy,"loader-color":e.vars.loaderColor}})],1):e._e(),a.name==="paddle"?t("div",{staticClass:"paddle-container"},[t("animated-loader",{attrs:{"is-loading":!e.paddleConfig.loaded&&!e.isBusy,"loader-color":e.vars.loaderColor}})],1):e._e(),a.name==="flutterwave"?t("div",{ref:"flutterwaveRef",refInFor:!0,staticClass:"flutterwave-container"},[t("animated-loader",{attrs:{"is-loading":!e.flutterwaveConfig.loaded&&!e.isBusy,"loader-color":e.vars.loaderColor}}),t("h4",{staticClass:"text-muted text-center py-4 my-4"},[e._v(e._s(e.$t("global.click_on",{attribute:e.$t("general.proceed")})))])],1):e._e()],1)}),1)],1)],1):e._e()]:e._e(),t("div",{staticClass:"form-footer mt-3"},[t("div",{staticClass:"left-side"},[t("base-button",{attrs:{type:"button",design:"light",tabindex:"-1"},on:{click:function(a){return e.$router.push({name:"appMembershipList",query:{reload:!0}})}}},[t("i",{staticClass:"fas fa-chevron-left"}),e._v(" "+e._s(e.$t("general.cancel")))])],1),t("div",{staticClass:"right-side"},[e.payableAmount&&(e.computedActiveTabName==="stripe"||e.computedActiveTabName==="flutterwave")?t("base-button",{attrs:{type:"submit",design:"primary"}},[e._v(e._s(e.$t("general.proceed"))+" "),t("i",{staticClass:"fas fa-chevron-right"})]):t("span",{staticClass:"text-muted"},[e._v(e._s(e.$t("membership.pay_to_proceed")))])],1)])],2)])},y=[],b=p(h,f,y,!1,null,null,null,null);const T=b.exports;export{T as default};
